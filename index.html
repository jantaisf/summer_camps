<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SF Summer Camp Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #0369a1; --primary-hover: #075985; --primary-light: #e0f2fe;
      --green: #059669; --amber: #d97706; --red: #dc2626;
      --bg: #f8f6f1; --surface: #fff; --border: #ddd4c0;
      --text: #1a2e3b; --muted: #56788a;
      --selected-bg: #e0f2fe; --selected-border: #7dd3fc;
      --k0-color: #2563eb; --k1-color: #0891b2;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg); color: var(--text); display: flex; flex-direction: column;
      height: 100vh; overflow: hidden; }

    /* ‚îÄ‚îÄ To use a photo header, paste an image URL into --header-photo below ‚îÄ‚îÄ */
    :root { --header-photo: url('https://images.unsplash.com/photo-1439066290691-510066268af5?auto=format&fit=crop&w=1920&q=80'); }

    header {
      background-color: #0c4a6e;
      background-image:
        linear-gradient(135deg, rgba(12,74,110,.82) 0%, rgba(3,105,161,.62) 42%, rgba(14,165,233,.52) 72%, rgba(12,74,110,.72) 100%),
        var(--header-photo);
      background-size: cover;
      background-position: center 40%;
      color: white; padding: 1.1rem 1.5rem;
      flex-shrink: 0; display: flex; align-items: center; gap: 1rem; }
    header h1 { font-family: 'Outfit', sans-serif; font-size: 1.45rem; font-weight: 800;
      letter-spacing: -.01em; text-shadow: 0 1px 6px rgba(0,0,0,.3); }
    header p  { opacity: .9; font-size: .82rem; font-style: italic; text-shadow: 0 1px 4px rgba(0,0,0,.25); }

    .settings { background: #f4f8fb; border-bottom: 1px solid var(--border);
      padding: .45rem 1.5rem; display: flex; flex-direction: column; gap: .3rem;
      flex-shrink: 0; }
    .settings-row { display: flex; flex-wrap: wrap; align-items: flex-end; gap: .75rem; }
    .kid-row { display: flex; flex-wrap: wrap; align-items: flex-end; gap: .75rem;
      padding: .2rem 0 .2rem .75rem; border-left: 3px solid var(--kid-color, #2563eb); }
    .sg { display: flex; flex-direction: column; gap: .2rem; }
    .sg label { font-size: .7rem; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: .04em; }
    .sg input, .sg select { padding: .4rem .6rem; border: 1px solid var(--border);
      border-radius: 7px; font-size: .85rem; background: white; outline: none; height: 34px; }
    .sg input:focus, .sg select:focus { border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(3,105,161,.14); }
    .sg input[type="text"] { width: 80px; }
    .toggle-group { display: flex; border: 1px solid var(--border); border-radius: 7px;
      overflow: hidden; height: 34px; }
    .tgl { padding: 0 .75rem; font-size: .78rem; font-weight: 700; border: none;
      background: white; cursor: pointer; color: var(--muted);
      border-right: 1px solid var(--border); transition: background .15s, color .15s; }
    .tgl:last-child { border-right: none; }
    .tgl.active { background: var(--primary); color: white; }

    main { flex: 1; display: grid; grid-template-columns: 420px 1fr; overflow: hidden; }

    .left-panel { background: #fafcfe; border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden; }
    .panel-hdr { padding: .85rem 1rem .65rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .panel-hdr h2 { font-size: .95rem; font-weight: 700; font-family: 'Outfit', sans-serif; }
    .summary { margin-top: .4rem; display: flex; flex-direction: column; gap: .22rem; }
    .sum-kid-row { display: flex; gap: .45rem; flex-wrap: wrap; align-items: center; }
    .sum-kid-label { font-size: .78rem; font-weight: 700; flex-shrink: 0; }
    .sum-stat { font-size: .78rem; color: var(--muted); }
    .sum-stat strong { color: var(--primary); }
    .sum-stat.amber strong { color: var(--amber); }
    .sum-stat.green strong { color: var(--green); }
    .sum-actions { display: flex; justify-content: flex-end; margin-top: .1rem; }
    .clear-btn { font-size: .72rem; color: var(--red); background: none; border: none;
      cursor: pointer; text-decoration: underline; }
    .week-list { flex: 1; overflow-y: auto; padding: .4rem; }
    .week-list::-webkit-scrollbar { width: 5px; }
    .week-list::-webkit-scrollbar-thumb { background: #b8cedd; border-radius: 3px; }
    .week-empty { padding: 1.5rem 1rem; text-align: center; color: var(--muted);
      font-size: .82rem; line-height: 1.5; }

    .week-item { display: flex; align-items: flex-start; gap: .4rem; padding: .5rem .65rem;
      border-radius: 8px; border: 2px solid transparent; cursor: pointer;
      transition: background .12s, border-color .12s; margin-bottom: .2rem; min-height: 48px; }
    .week-item:hover { background: #e8f4fb; }
    .week-item.selected { background: var(--selected-bg); border-color: var(--selected-border); }
    .wk-num { font-size: .68rem; font-weight: 800; color: var(--muted);
      width: 1.6rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      padding-top: .25rem; }
    .wk-dates { flex: 0 0 auto; min-width: 82px; display: flex; flex-direction: column; justify-content: flex-start; padding-top: .15rem; }
    .wk-dates .d { font-size: .8rem; font-weight: 600; }
    .wk-dates .hol { font-size: .7rem; color: var(--amber); font-weight: 500; }
    .wk-kids-stack { display: flex; flex-direction: column; flex: 1; min-width: 0;
      gap: .18rem; border-left: 1px solid var(--border); padding-left: .45rem; padding-top: .05rem; }
    .wk-col { display: flex; flex-direction: row; align-items: center; gap: .35rem;
      min-width: 0; width: 100%; padding: .1rem .2rem;
      cursor: pointer; border-radius: 5px; }
    .wk-col:hover { background: rgba(0,0,0,.04); }
    .wk-kid-lbl { font-size: .6rem; font-weight: 800; flex-shrink: 0;
      white-space: nowrap; min-width: 34px; letter-spacing: .02em; text-transform: uppercase; }
    .wk-col-chips { display: flex; flex-direction: column; align-items: flex-start; gap: .15rem; flex: 1; min-width: 0; }
    .wk-na { font-size: .65rem; color: #cbd5e1; }
    .week-item.vacation { background: #fffbeb !important; }
    .week-item.vacation:hover { background: #fef3c7 !important; }
    .week-item.vacation.selected { background: #fef9c3 !important; border-color: #fde047 !important; }
    .wk-num { cursor: pointer; border-radius: 5px; padding: 2px 3px; transition: background .15s; }
    .wk-num:hover { background: rgba(0,0,0,.07); }
    .wk-vac-pill { font-size: .68rem; font-weight: 700; color: #92400e;
      padding: .18rem .45rem; border-radius: 99px; background: #fef3c7; white-space: nowrap; }
    .wk-open { font-size: .7rem; font-weight: 600; color: var(--muted);
      padding: .18rem .45rem; border-radius: 99px; background: #ddeef8; }
    .wk-chip { display: flex; align-items: center; gap: .25rem; font-size: .72rem;
      font-weight: 700; padding: .22rem .5rem .22rem .45rem; border-radius: 99px;
      color: white; max-width: 125px; }
    .wk-chip span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .wk-rm { background: none; border: none; cursor: pointer; color: white;
      font-size: .72rem; opacity: .8; flex-shrink: 0; line-height: 1; padding: 0; }
    .wk-rm:hover { opacity: 1; }
    .wk-chip-consider { display: flex; align-items: center; gap: .2rem; font-size: .72rem;
      font-weight: 700; padding: .22rem .45rem; border-radius: 99px;
      background: #fef9c3; border: 1.5px dashed #ca8a04; color: #78350f; max-width: 125px; }
    .wk-chip-consider span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }
    .wk-promote { background: none; border: none; cursor: pointer; color: #92400e;
      font-size: .75rem; font-weight: 700; opacity: .75; flex-shrink: 0; line-height: 1; padding: 0; }
    .wk-promote:hover { opacity: 1; }
    .wk-rm-consider { background: none; border: none; cursor: pointer; color: #92400e;
      font-size: .72rem; opacity: .7; flex-shrink: 0; line-height: 1; padding: 0; }
    .wk-rm-consider:hover { opacity: 1; }

    .right-panel { display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
    .right-panel .panel-hdr { background: #fafcfe; border-bottom: 1px solid var(--border);
      display: flex; align-items: flex-start; justify-content: space-between; }
    .right-panel .panel-hdr h2 { font-size: .9rem; font-family: 'Outfit', sans-serif; }
    .right-hdr-left { display: flex; flex-direction: column; gap: .3rem; }
    .camp-count { font-size: .78rem; color: var(--muted); padding-top: .15rem; }
    .kid-tabs { display: flex; gap: .25rem; }
    .kid-tab { padding: .2rem .6rem; border-radius: 99px; font-size: .75rem;
      font-weight: 700; cursor: pointer; border: 1.5px solid transparent;
      background: #ddeef8; color: var(--muted); }
    .kid-tab.k0.active { background: #eff6ff; border-color: #2563eb; color: #2563eb; }
    .kid-tab.k1.active { background: #f0fdfa; border-color: #0891b2; color: #0891b2; }
    .search-bar { background: #fafcfe; padding: .5rem 1rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .search-wrap { position: relative; }
    .search-wrap svg { position: absolute; left: .55rem; top: 50%; transform: translateY(-50%);
      color: var(--muted); pointer-events: none; }
    .search-wrap input { width: 100%; padding: .4rem .7rem .4rem 1.9rem; border: 1px solid var(--border);
      border-radius: 7px; font-size: .85rem; background: #f4f8fb; outline: none; }
    .search-wrap input:focus { border-color: var(--primary); background: white;
      box-shadow: 0 0 0 3px rgba(3,105,161,.12); }

    .camp-grid { flex: 1; overflow-y: auto; padding: .85rem;
      display: grid; grid-template-columns: repeat(auto-fill, minmax(272px, 1fr));
      gap: .75rem; align-content: start; }
    .camp-grid::-webkit-scrollbar { width: 5px; }
    .camp-grid::-webkit-scrollbar-thumb { background: #b8cedd; border-radius: 3px; }
    .no-results { grid-column: 1/-1; text-align: center; padding: 3rem 1rem;
      color: var(--muted); font-size: .875rem; }

    .card { background: white; border-radius: 14px; border: 1px solid var(--border);
      display: flex; flex-direction: column;
      transition: box-shadow .2s, transform .15s; }
    .card:hover { box-shadow: 0 6px 24px rgba(3,105,161,.12); transform: translateY(-1px); }
    .card-bar { height: 5px; border-radius: 14px 14px 0 0; }
    .card-body { padding: .8rem .9rem; flex: 1; }
    .card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: .4rem; }
    .card-name { font-size: .88rem; font-weight: 700; line-height: 1.3; }
    .badges { display: flex; flex-direction: column; align-items: flex-end; gap: .2rem; flex-shrink: 0; }
    .badge { font-size: .66rem; font-weight: 700; padding: .18rem .42rem; border-radius: 99px; white-space: nowrap; }
    .badge-day { background: #dbeafe; color: #1e40af; }
    .badge-sleep { background: #fce7f3; color: #9d174d; }
    .badge-type { background: #ddeef8; color: var(--muted); }
    .tag-input-wrap { display:flex; flex-wrap:wrap; gap:.3rem; padding:.35rem .5rem; border:1px solid var(--border); border-radius:7px; background:white; min-height:34px; cursor:text; align-items:center; }
    .tag-chip { display:inline-flex; align-items:center; gap:.2rem; padding:.1rem .45rem; background:#0369a1; color:white; border-radius:99px; font-size:.73rem; font-weight:700; }
    .tag-chip-x { cursor:pointer; opacity:.7; font-size:.85rem; line-height:1; margin-left:.1rem; }
    .tag-chip-x:hover { opacity:1; }
    .badge-apply   { background: #fef3c7; color: #92400e; }
    .badge-reg     { background: #dcfce7; color: #166534; }
    .badge-custom  { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .card-desc { margin-top: .35rem; font-size: .78rem; color: var(--muted); line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .session-pill { margin-top: .4rem; display: inline-block; padding: .25rem .55rem;
      background: #fdf4ff; border-radius: 6px; font-size: .74rem; color: #7e22ce; font-weight: 600; }
    .verified-pill { margin-top: .3rem; display: inline-block; padding: .15rem .45rem;
      background: #f0fdf4; border-radius: 6px; font-size: .7rem; color: #166534; font-weight: 600; }
    .est-pill { margin-top: .3rem; display: inline-block; padding: .15rem .45rem;
      background: #fefce8; border-radius: 6px; font-size: .7rem; color: #854d0e; font-weight: 600; }
    .coming-soon-pill { margin-top: .3rem; display: inline-block; padding: .15rem .45rem;
      background: #fff7ed; border-radius: 6px; font-size: .7rem; color: #9a3412; font-weight: 600; }
    .card-meta { margin-top: .55rem; display: grid; grid-template-columns: auto 1fr;
      gap: .15rem .4rem; font-size: .75rem; }
    .mk { font-weight: 600; color: var(--muted); white-space: nowrap; }
    .mv { color: var(--text); }
    .card-foot { padding: .6rem .9rem; border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; }
    .cost { font-size: .88rem; font-weight: 700; color: var(--primary); }
    .btn { padding: .38rem .8rem; border-radius: 7px; font-size: .77rem; font-weight: 700;
      border: 1.5px solid var(--primary); cursor: pointer; transition: background .15s, color .15s;
      text-decoration: none; display: inline-block; }
    .btn-solid { background: var(--primary); color: white; }
    .btn-solid:hover { background: var(--primary-hover); }
    .btn-solid:disabled { opacity: .4; cursor: not-allowed; }
    .btn-outline { background: white; color: var(--primary); }
    .btn-outline:hover { background: var(--primary-light); }

    /* Expandable card */
    .card { cursor: pointer; }
    .card.expanded { border-color: var(--primary); box-shadow: 0 6px 28px rgba(3,105,161,.18); transform: none !important; }
    .sessions-section { border-top: 1px solid var(--border); padding: .6rem .9rem .5rem; }
    .sessions-section-title { font-size: .7rem; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: .05em; margin-bottom: .4rem; }
    .card-expand { border-top: 1px solid var(--border); padding: .65rem .9rem; background: #f4f8fb; border-radius: 0 0 14px 14px; }
    .sessions-list { list-style: none; display: flex; flex-direction: column; gap: .25rem; margin-bottom: .6rem; }
    .sessions-list li { font-size: .78rem; padding: .28rem .5rem; background: white;
      border-radius: 6px; border: 1px solid var(--border); color: var(--text);
      display: flex; justify-content: space-between; align-items: center; gap: .5rem;
      cursor: pointer; transition: background .15s, border-color .15s; }
    .sessions-list li:hover { background: #eff6ff; border-color: var(--primary); }
    .sessions-list li.sess-planned { background: #f0fdf4; border-color: #86efac; }
    .sessions-list li.sess-planned:hover { background: #dcfce7; border-color: #4ade80; }
    .sessions-list li.sess-considering { background: #fef9c3; border-color: #ca8a04; }
    .sessions-list li.sess-considering:hover { background: #fef08a; border-color: #a16207; }
    .sess-label { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: .1rem; }
    .sess-deadline { font-size: .67rem; font-weight: 700; color: #b45309; }
    .sess-loc { font-size: .67rem; color: #64748b; }
    .sess-action { font-size: .7rem; font-weight: 700; white-space: nowrap; flex-shrink: 0;
      color: var(--primary); display: flex; align-items: center; gap: .25rem; }
    .sess-planned .sess-action { color: var(--green); }
    .sess-considering .sess-action { color: #92400e; }
    .sess-remove-btn { background: none; border: none; cursor: pointer; font-size: .7rem;
      color: #92400e; opacity: .7; padding: 0; line-height: 1; }
    .sess-remove-btn:hover { opacity: 1; }
    .card-chevron { font-size: .7rem; color: var(--muted); transition: transform .2s; flex-shrink: 0; }
    .card.expanded .card-chevron { transform: rotate(180deg); }

    /* ‚îÄ‚îÄ Auth modal ‚îÄ‚îÄ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,.6);
      backdrop-filter: blur(4px); display: flex; align-items: center;
      justify-content: center; z-index: 1000; }
    .modal { background: white; border-radius: 16px; padding: 2rem 2.25rem;
      width: 380px; max-width: calc(100vw - 2rem);
      box-shadow: 0 25px 60px rgba(0,0,0,.25); }
    .modal-logo { font-size: 1.8rem; margin-bottom: .3rem; }
    .modal h2 { font-size: 1.25rem; font-weight: 800; font-family: 'Outfit', sans-serif; }
    .modal-sub { font-size: .83rem; color: var(--muted); margin: .2rem 0 1.4rem; }
    .modal-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.25rem; }
    .modal-tab { padding: .45rem .9rem; font-size: .83rem; font-weight: 700;
      border: none; background: none; cursor: pointer; color: var(--muted);
      border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .modal-field { display: flex; flex-direction: column; gap: .3rem; margin-bottom: .9rem; }
    .modal-field label { font-size: .72rem; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: .04em; }
    .modal-field input { padding: .55rem .75rem; border: 1.5px solid var(--border);
      border-radius: 8px; font-size: .9rem; outline: none; }
    .modal-field input:focus { border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(3,105,161,.14); }
    .auth-msg { font-size: .8rem; min-height: 1.2em; margin-bottom: .6rem; }
    .auth-msg.error { color: var(--red); }
    .auth-msg.info  { color: var(--green); }
    .auth-submit { width: 100%; padding: .65rem; border-radius: 8px;
      background: var(--primary); color: white; border: none;
      font-size: .92rem; font-weight: 700; cursor: pointer; }
    .auth-submit:hover { background: var(--primary-hover); }
    .auth-submit:disabled { opacity: .5; cursor: not-allowed; }

    /* ‚îÄ‚îÄ User bar in header ‚îÄ‚îÄ */
    .user-bar { margin-left: auto; display: flex; align-items: center; gap: .75rem; }
    .user-email { font-size: .82rem; opacity: .75; }
    .save-dot { font-size: .78rem; opacity: .65; }
    .signout-btn { padding: .3rem .7rem; border-radius: 6px;
      border: 1.5px solid rgba(255,255,255,.45); background: transparent;
      color: white; font-size: .78rem; font-weight: 700; cursor: pointer; }
    .signout-btn:hover { background: rgba(255,255,255,.15); }

    #campMap { flex: 1; overflow: hidden; display: none; }
    .leaflet-popup-content { margin: 10px 12px; font-family: 'Inter', sans-serif; }
    .leaflet-popup-content-wrapper { border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,.15); }

    @media (max-width: 900px) {
      body { height: auto; overflow: auto; }
      main { grid-template-columns: 1fr; height: auto; overflow: visible; }
      .left-panel { height: auto; overflow: visible; border-right: none; border-bottom: 1px solid var(--border); }
      .week-list { max-height: 320px; overflow-y: auto; }
      .right-panel { height: auto; overflow: visible; }
      .camp-grid { max-height: none; overflow: visible; }
    }

    /* ‚îÄ‚îÄ Collab pill in header ‚îÄ‚îÄ */
    .collab-pill { display:flex; align-items:center; gap:.4rem; font-size:.75rem;
      background:rgba(255,255,255,.15); border-radius:99px; padding:.2rem .65rem; cursor:pointer;
      border: 1.5px solid rgba(255,255,255,.3); color:white; white-space:nowrap; }
    .collab-pill .dot { width:7px; height:7px; border-radius:50%; background:#34d399; flex-shrink:0; }
    .collab-area-wrap { position:relative; }
    .collab-menu { position:absolute; right:0; top:calc(100%+4px); background:#fff;
      border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.12);
      min-width:190px; z-index:200; overflow:hidden; }
    .collab-menu button { display:block; width:100%; text-align:left;
      padding:.55rem 1rem; font-size:.8rem; background:none; border:none; cursor:pointer; color:var(--text); }
    .collab-menu button:hover { background:#f1f5f9; }
    .collab-menu .cm-divider { height:1px; background:var(--border); margin:.2rem 0; }

    /* ‚îÄ‚îÄ Group friends on camp cards ‚îÄ‚îÄ */
    .group-friends { margin-top:.5rem; padding-top:.5rem; border-top:1px dashed var(--border);
      font-size:.7rem; color:#64748b; line-height:1.6; }

    /* ‚îÄ‚îÄ Week friend initials ‚îÄ‚îÄ */
    .wk-friends { display:flex; gap:.2rem; align-items:center; flex-shrink:0; padding-left:.3rem; }
    .wk-friend-init { width:18px; height:18px; border-radius:50%; display:flex; align-items:center;
      justify-content:center; font-size:.55rem; font-weight:700; color:#fff; flex-shrink:0; }

    /* ‚îÄ‚îÄ Collab modal extras ‚îÄ‚îÄ */
    .collab-modal-tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:1.25rem; }
    .collab-modal-tab { padding:.45rem .9rem; font-size:.83rem; font-weight:700;
      border:none; background:none; cursor:pointer; color:var(--muted);
      border-bottom:2px solid transparent; margin-bottom:-1px; }
    .collab-modal-tab.active { color:var(--primary); border-bottom-color:var(--primary); }
    .invite-link-box { display:flex; align-items:center; gap:.5rem; background:#f4f8fb;
      border:1px solid var(--border); border-radius:8px; padding:.5rem .75rem; margin:.6rem 0; }
    .invite-link-box input { flex:1; border:none; background:transparent; font-size:.78rem;
      color:var(--text); outline:none; font-family:monospace; min-width:0; }
    .invite-code-box { font-family:monospace; font-size:1.4rem; font-weight:800; letter-spacing:.15em;
      background:#f4f8fb; border:1px solid var(--border); border-radius:8px;
      padding:.65rem 1rem; text-align:center; color:var(--primary); margin:.6rem 0; }
    .member-list { list-style:none; display:flex; flex-direction:column; gap:.4rem; margin:.6rem 0; }
    .member-list li { display:flex; align-items:center; gap:.5rem; font-size:.83rem;
      padding:.35rem .5rem; border-radius:7px; background:#f8f9fa; }
    .member-list li .member-dot { width:8px; height:8px; border-radius:50%; background:#34d399; flex-shrink:0; }

    /* ‚îÄ‚îÄ Recommendation Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .wiz-overlay{position:fixed;inset:0;background:rgba(10,18,40,.75);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:1050;}
    .wiz-modal{background:white;border-radius:20px;width:580px;max-width:calc(100vw - 1.5rem);max-height:calc(100vh - 2rem);display:flex;flex-direction:column;overflow:hidden;box-shadow:0 32px 90px rgba(0,0,0,.32);}
    .wiz-hdr{background:linear-gradient(135deg,#0c4a6e,#0369a1 60%,#0ea5e9);color:white;padding:1.25rem 1.65rem .85rem;flex-shrink:0;}
    .wiz-hdr h2{font-family:'Outfit',sans-serif;font-size:1.28rem;font-weight:800;margin-bottom:.18rem;}
    .wiz-hdr p{font-size:.79rem;opacity:.82;}
    .wiz-prog{display:flex;gap:.22rem;margin-top:.75rem;}
    .wiz-prog-dot{height:4px;flex:1;border-radius:2px;background:rgba(255,255,255,.27);transition:background .3s;}
    .wiz-prog-dot.on{background:rgba(255,255,255,.9);}
    .wiz-body{flex:1;overflow-y:auto;padding:1.3rem 1.65rem;}
    .wiz-foot{padding:.82rem 1.65rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;background:#fafcfe;}
    .wiz-sec-title{font-size:.94rem;font-weight:700;font-family:'Outfit',sans-serif;color:var(--text);margin-bottom:.18rem;}
    .wiz-sec-sub{font-size:.78rem;color:var(--muted);margin-bottom:1rem;line-height:1.5;}
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:.4rem;}
    .pref-chip{padding:.5rem .65rem;border:2px solid var(--border);border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:.38rem;font-size:.78rem;font-weight:600;color:var(--muted);transition:all .15s;user-select:none;}
    .pref-chip:hover{border-color:var(--primary);color:var(--primary);background:#f0f9ff;}
    .pref-chip.on{border-color:var(--primary);background:var(--primary-light);color:var(--primary);}
    .wiz-style-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.42rem;margin-bottom:.9rem;}
    .wiz-mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:.42rem;}
    .wiz-card{border:2px solid var(--border);border-radius:11px;padding:.72rem .88rem;cursor:pointer;transition:all .15s;}
    .wiz-card:hover{border-color:var(--primary);background:#f0f9ff;}
    .wiz-card.on{border-color:var(--primary);background:var(--primary-light);}
    .wiz-card-title{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:.14rem;}
    .wiz-card-desc{font-size:.72rem;color:var(--muted);line-height:1.4;}
    .wiz-kid-block{border:1.5px solid var(--border);border-radius:11px;padding:.78rem .92rem;margin-bottom:.52rem;}
    .wiz-kid-label{font-size:.66rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:.52rem;display:flex;align-items:center;gap:.35rem;}
    .wiz-field-row{display:flex;gap:.52rem;flex-wrap:wrap;align-items:flex-end;}
    .wf{display:flex;flex-direction:column;gap:.2rem;}
    .wf label{font-size:.66rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;}
    .wf input,.wf select{padding:.36rem .56rem;border:1.5px solid var(--border);border-radius:8px;font-size:.82rem;background:white;outline:none;height:34px;}
    .wf input:focus,.wf select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(3,105,161,.12);}
    .wiz-toggle-row{display:flex;flex-wrap:wrap;gap:.38rem;margin-bottom:.88rem;}
    .wiz-tgl{padding:.38rem .88rem;border:2px solid var(--border);border-radius:99px;font-size:.79rem;font-weight:700;cursor:pointer;background:white;color:var(--muted);transition:all .15s;}
    .wiz-tgl:hover{border-color:var(--primary);color:var(--primary);}
    .wiz-tgl.on{border-color:var(--primary);background:var(--primary-light);color:var(--primary);}
    .wiz-rec-card{display:flex;align-items:center;gap:.68rem;background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:.62rem .88rem;margin-bottom:.38rem;}
    .wiz-rec-week{font-size:.69rem;font-weight:700;color:var(--muted);white-space:nowrap;min-width:74px;}
    .wiz-rec-info{flex:1;min-width:0;}
    .wiz-rec-name{font-size:.83rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .wiz-rec-meta{font-size:.7rem;color:var(--muted);margin-top:.05rem;}
    .wiz-rec-who{font-size:.67rem;font-weight:700;padding:.07rem .3rem;border-radius:99px;background:white;border:1px solid var(--border);color:var(--muted);flex-shrink:0;}
    .btn-wiz-pri{padding:.48rem 1.1rem;border-radius:8px;font-size:.83rem;font-weight:700;cursor:pointer;background:var(--primary);color:white;border:none;transition:background .15s;}
    .btn-wiz-pri:hover{background:var(--primary-hover);}
    .btn-wiz-sec{padding:.48rem 1.1rem;border-radius:8px;font-size:.83rem;font-weight:700;cursor:pointer;background:white;color:var(--muted);border:1.5px solid var(--border);transition:background .15s;}
    .btn-wiz-sec:hover{background:#f4f8fb;}
    .btn-wiz-skip{background:none;border:none;font-size:.77rem;color:var(--muted);cursor:pointer;text-decoration:underline;}
    .wiz-trigger{padding:.33rem .82rem;border-radius:99px;background:rgba(255,255,255,.16);border:1.5px solid rgba(255,255,255,.36);color:white;font-size:.78rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:background .15s;}
    .wiz-trigger:hover{background:rgba(255,255,255,.26);}
    .wiz-vac-grid{display:flex;flex-wrap:wrap;gap:.38rem;margin-top:.25rem;}
    .wiz-vac-pill{padding:.4rem .72rem;border:2px solid var(--border);border-radius:8px;cursor:pointer;font-size:.77rem;font-weight:600;color:var(--muted);transition:all .15s;user-select:none;}
    .wiz-vac-pill:hover{border-color:#f59e0b;color:#92400e;background:#fffbeb;}
    .wiz-vac-pill.on{border-color:#f59e0b;background:#fef3c7;color:#92400e;}
    .wiz-filter-bar{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:.6rem .9rem;margin-bottom:.85rem;font-size:.77rem;display:flex;align-items:center;gap:.45rem;flex-wrap:wrap;}
    .wiz-filter-tag{background:var(--primary-light);color:var(--primary);font-weight:700;padding:.15rem .42rem;border-radius:99px;font-size:.72rem;}
  </style>
</head>
<body>

<!-- Profile Settings Modal -->
<div id="profileModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeProfile()">
  <div class="modal" style="width:440px;max-width:calc(100vw - 2rem)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h2 style="font-size:1.1rem">Profile Settings</h2>
      <button onclick="closeProfile()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <p style="font-size:.82rem;color:var(--muted);margin-bottom:1.25rem;line-height:1.5">
      Add your addresses to get camp recommendations near home or work. Both are optional.
    </p>
    <div class="modal-field">
      <label>üè† Home address</label>
      <input type="text" id="profileHome" placeholder="e.g. 123 Main St, San Francisco, CA" autocomplete="home street-address" style="width:100%" />
    </div>
    <div class="modal-field">
      <label>üè¢ Work address</label>
      <input type="text" id="profileWork" placeholder="e.g. 456 Market St, San Francisco, CA" autocomplete="work street-address" style="width:100%" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem">
      <button class="btn btn-outline" onclick="closeProfile()">Cancel</button>
      <button class="btn btn-solid" onclick="saveProfile()">Save</button>
    </div>
  </div>
</div>

<!-- Recommendation Wizard -->
<div id="wizOverlay" class="wiz-overlay" style="display:none">
  <div class="wiz-modal">
    <div class="wiz-hdr">
      <h2 id="wizTitle">Find Perfect Camps</h2>
      <p id="wizSub">Answer a few questions and we'll build a personalized plan</p>
      <div class="wiz-prog" id="wizProg"></div>
    </div>
    <div class="wiz-body" id="wizBody"></div>
    <div class="wiz-foot">
      <button class="btn-wiz-sec" id="wizBackBtn" onclick="wizNav(-1)">Cancel</button>
      <div style="display:flex;align-items:center;gap:.82rem">
        <button class="btn-wiz-skip" onclick="closeWizard()">Skip for now</button>
        <button class="btn-wiz-pri" id="wizNextBtn" onclick="wizNav(1)">Next ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin panel -->
<div id="adminPanel" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeAdmin()">
  <div class="modal" style="width:520px;max-width:calc(100vw - 2rem)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h2 style="font-size:1.1rem">A/B Test Results</h2>
      <button onclick="closeAdmin()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <div id="adminContent" style="font-size:.85rem"></div>
  </div>
</div>

<!-- Add/Edit custom camp modal -->
<div id="addCampModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeAddCampModal()">
  <div class="modal" style="width:480px;max-width:calc(100vw - 2rem);max-height:90vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
      <h2 id="addCampModalTitle" style="font-size:1.1rem">Add Custom Camp</h2>
      <button onclick="closeAddCampModal()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <div class="modal-field">
      <label>Camp name *</label>
      <input type="text" id="cc_name" placeholder="e.g. Oakland Nature School" autocomplete="off" />
    </div>
    <div class="modal-field">
      <label>Main website URL</label>
      <input type="url" id="cc_website_url" placeholder="https://campname.org" autocomplete="off" />
    </div>
    <div class="modal-field">
      <label>Camp info / registration URL</label>
      <input type="url" id="cc_url" placeholder="https://campname.org/summer-camp" autocomplete="off" />
    </div>
    <div style="display:flex;gap:.75rem;margin-bottom:.9rem;align-items:flex-end">
      <div class="sg" style="flex:1">
        <label>Tags (press Enter to add)</label>
        <div id="cc_tags_wrap" class="tag-input-wrap" onclick="document.getElementById('cc_tag_input').focus()">
          <input type="text" id="cc_tag_input" placeholder="e.g. Coding, STEM, Tennis‚Ä¶"
            style="border:none;outline:none;font-size:.82rem;min-width:90px;flex:1;background:transparent;padding:0"
            onkeydown="handleTagInput(event)" />
        </div>
      </div>
      <div class="sg">
        <label>Style</label>
        <div class="toggle-group">
          <button class="tgl active" id="cc_day_btn" onclick="setCampStyle('day')">Day</button>
          <button class="tgl" id="cc_sleep_btn" onclick="setCampStyle('sleep')">Sleepaway</button>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:.75rem;margin-bottom:.9rem">
      <div class="sg" style="flex:1">
        <label>Ages</label>
        <div style="display:flex;gap:.35rem;align-items:center">
          <input type="number" id="cc_age_min" min="3" max="18" value="5"
            style="width:54px;padding:.4rem .5rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;height:34px;background:white" />
          <span style="font-size:.8rem;color:var(--muted)">‚Äì</span>
          <input type="number" id="cc_age_max" min="3" max="18" value="15"
            style="width:54px;padding:.4rem .5rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;height:34px;background:white" />
        </div>
      </div>
      <div class="sg" style="flex:2">
        <label>Cost</label>
        <input type="text" id="cc_cost" placeholder="e.g. ~$600/week"
          style="width:100%;height:34px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;background:white" />
      </div>
    </div>
    <!-- Location fields: shown for custom camps -->
    <div id="cc_location_fields" class="modal-field">
      <label>Location</label>
      <input type="text" id="cc_street" placeholder="Street address (optional)" autocomplete="off" style="margin-bottom:.35rem" />
      <div style="display:flex;gap:.5rem;margin-bottom:.35rem">
        <input type="text" id="cc_city" placeholder="City" autocomplete="off"
          style="flex:2;padding:.45rem .65rem;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;outline:none" />
        <input type="text" id="cc_state" placeholder="State" autocomplete="off"
          style="width:68px;padding:.45rem .65rem;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;outline:none" />
      </div>
      <div style="display:flex;gap:.5rem">
        <input type="text" id="cc_zip" placeholder="ZIP" autocomplete="off"
          style="width:90px;padding:.45rem .65rem;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;outline:none" />
        <input type="text" id="cc_country" placeholder="Country" autocomplete="off"
          style="flex:1;padding:.45rem .65rem;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;outline:none" />
      </div>
    </div>
    <!-- Locations section: shown for admin camps only -->
    <div id="cc_locations_section" style="display:none;margin-bottom:.9rem">
      <div style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.5rem">Locations</div>
      <div id="cc_location_rows"></div>
      <button type="button" onclick="addLocationRow()" style="margin-top:.4rem;font-size:.82rem;color:var(--primary);background:none;border:none;cursor:pointer;padding:.15rem 0;font-weight:600">+ Add Location</button>
    </div>
    <div class="modal-field">
      <label>Description</label>
      <textarea id="cc_desc" rows="2" placeholder="Brief description (optional)"
        style="padding:.5rem .75rem;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;resize:vertical;width:100%;font-family:inherit;outline:none;line-height:1.5"></textarea>
    </div>
    <div style="margin-bottom:.9rem">
      <div style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem">Availability</div>
      <label style="display:flex;align-items:center;gap:.5rem;font-size:.85rem;cursor:pointer">
        <input type="checkbox" id="cc_all_summer" checked onchange="toggleCampDateRange()" />
        Available all summer (no date filter)
      </label>
      <div id="cc_dates_row" style="display:none;margin-top:.55rem;align-items:center">
        <div style="display:flex;gap:.5rem;align-items:center">
          <input type="date" id="cc_date_start"
            style="height:34px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;background:white" />
          <span style="color:var(--muted);font-size:.85rem">to</span>
          <input type="date" id="cc_date_end"
            style="height:34px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;background:white" />
        </div>
      </div>
    </div>
    <div class="modal-field">
      <label>Application deadline <span style="font-weight:400;color:var(--muted)">(optional)</span></label>
      <input type="date" id="cc_app_deadline"
        style="height:34px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:7px;font-size:.85rem;background:white" />
    </div>
    <div id="cc_msg" style="font-size:.8rem;color:var(--red);min-height:1.2em;margin-bottom:.5rem"></div>
    <div style="display:flex;justify-content:flex-end;gap:.75rem">
      <button class="btn btn-outline" onclick="closeAddCampModal()">Cancel</button>
      <button class="btn btn-solid" id="cc_submit" onclick="submitCustomCamp()">Add Camp</button>
    </div>
  </div>
</div>

<!-- Household modal -->
<div id="householdModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeHouseholdModal()">
  <div class="modal" style="width:440px;max-width:calc(100vw - 2rem)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
      <h2 id="hhModalTitle" style="font-size:1.1rem">Share Your Plan</h2>
      <button onclick="closeHouseholdModal()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <div id="hhModalContent"></div>
  </div>
</div>

<!-- Group modal -->
<div id="groupModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeGroupModal()">
  <div class="modal" style="width:440px;max-width:calc(100vw - 2rem)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h2 id="grpModalTitle" style="font-size:1.1rem">Friend Group</h2>
      <button onclick="closeGroupModal()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <div id="grpModalContent"></div>
  </div>
</div>

<!-- Admin camps modal -->
<div id="adminCampsModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeAdminCampsModal()">
  <div class="modal" style="width:660px;max-width:calc(100vw - 2rem);max-height:85vh;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.85rem">
      <h2 style="font-size:1.1rem">Manage Camps</h2>
      <button onclick="closeAdminCampsModal()" style="background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted);line-height:1">‚úï</button>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:.6rem">
      <button class="btn btn-solid" style="font-size:.78rem" onclick="openAdminAddCamp()">+ Add Camp</button>
    </div>
    <div id="adminCampsList" style="overflow-y:auto;flex:1;border-top:1px solid var(--border)"></div>
  </div>
</div>

<!-- Auth modal -->
<div id="authModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-logo">üåâ</div>
    <h2>SF Summer Camp Planner</h2>
    <p class="modal-sub">Sign in to save your plan across sessions</p>
    <button id="googleSignInBtn" onclick="signInWithGoogle()"
      style="width:100%;padding:.65rem;border:1px solid #dadce0;border-radius:8px;
             background:#fff;display:flex;align-items:center;justify-content:center;
             gap:.6rem;font-size:.9rem;font-weight:500;cursor:pointer;margin-bottom:1rem">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
           width="18" height="18" alt="">
      Continue with Google
    </button>
    <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:1rem">
      <div style="flex:1;height:1px;background:var(--border)"></div>
      <span style="font-size:.75rem;color:var(--muted)">or</span>
      <div style="flex:1;height:1px;background:var(--border)"></div>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" id="tabSignin" onclick="switchTab('signin')">Sign in</button>
      <button class="modal-tab" id="tabSignup" onclick="switchTab('signup')">Create account</button>
    </div>
    <div class="modal-field">
      <label>Email</label>
      <input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" />
    </div>
    <div class="modal-field">
      <label>Password</label>
      <input type="password" id="authPassword" placeholder="Password"
        onkeydown="if(event.key==='Enter')handleAuth()" />
    </div>
    <div id="authMsg" class="auth-msg"></div>
    <button class="auth-submit" id="authSubmit" onclick="handleAuth()">Sign in</button>
  </div>
</div>

<header>
  <div>
    <h1>üåâ SF Summer Camp Planner ‚Äî 2026</h1>
    <p>Plan each child's summer week by week ¬∑ Sleepaway dates verified from camp websites ¬∑ Day camp dates estimated</p>
  </div>
  <div class="user-bar" id="userBar" style="display:none">
    <button class="wiz-trigger" onclick="openWizard()">‚ú® Get Recommendations</button>
    <span class="user-email" id="userEmail"></span>
    <span class="save-dot" id="saveDot"></span>
    <div class="collab-area-wrap" id="collabArea"></div>
    <button class="signout-btn" onclick="openProfile()">‚öô Profile</button>
    <button class="signout-btn" onclick="signOut()">Sign out</button>
  </div>
</header>

<div class="settings">
  <div id="kidRows"></div>
  <!-- Shared filters row -->
  <div class="settings-row">
    <div class="sg">
      <label>Children</label>
      <div class="toggle-group" id="kidCountToggle">
        <button class="tgl" onclick="setKidCount(1)">1</button>
        <button class="tgl active" onclick="setKidCount(2)">2</button>
        <button class="tgl" onclick="setKidCount(3)">3</button>
        <button class="tgl" onclick="setKidCount(4)">4</button>
      </div>
    </div>
    <div class="sg">
      <label>Camp type</label>
      <div class="toggle-group">
        <button class="tgl active" data-sl="">Both</button>
        <button class="tgl" data-sl="day">Day</button>
        <button class="tgl" data-sl="sleep">Sleepaway</button>
      </div>
    </div>
    <div class="sg">
      <label>Admission</label>
      <div class="toggle-group">
        <button class="tgl active" data-app="">All</button>
        <button class="tgl" data-app="reg">Register</button>
        <button class="tgl" data-app="apply">Apply</button>
      </div>
    </div>
    <div class="sg">
      <label>Format</label>
      <div class="toggle-group">
        <button class="tgl active" data-virt="">All</button>
        <button class="tgl" data-virt="inperson">In-Person</button>
        <button class="tgl" data-virt="virtual">Virtual</button>
      </div>
    </div>
    <div class="sg">
      <label>Activity</label>
      <select id="actFilter">
        <option value="">All activities</option>
      </select>
    </div>
    <div class="sg">
      <label>Distance</label>
      <div style="display:flex;gap:.4rem;align-items:center">
        <input type="text" id="zipInput" placeholder="ZIP" maxlength="5" inputmode="numeric"
          style="width:62px;padding:.28rem .4rem;border:1px solid var(--border);border-radius:6px;font-size:.82rem;background:var(--surface)">
        <select id="distFilter" style="padding:.28rem .4rem;border:1px solid var(--border);border-radius:6px;font-size:.82rem;background:var(--surface)">
          <option value="">Any distance</option>
          <option value="5">within 5 mi</option>
          <option value="10">within 10 mi</option>
          <option value="20">within 20 mi</option>
          <option value="50">within 50 mi</option>
        </select>
      </div>
    </div>
  </div>
</div>

<main>
  <div class="left-panel">
    <div class="panel-hdr">
      <h2 onclick="handleTitleClick()" style="cursor:default;user-select:none">Your Summer</h2>
      <div class="summary" id="summary"></div>
    </div>
    <div class="week-list" id="weekList"></div>
  </div>

  <div class="right-panel">
    <div class="panel-hdr">
      <div class="right-hdr-left">
        <h2 id="campsTitle">All Camps</h2>
        <div class="kid-tabs" id="kidTabs"></div>
      </div>
      <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
        <div class="toggle-group" style="height:28px">
          <button class="tgl active" id="viewListBtn" onclick="setMapView(false)">List</button>
          <button class="tgl" id="viewMapBtn" onclick="setMapView(true)">Map</button>
        </div>
        <span class="camp-count" id="campCount"></span>
        <button class="btn btn-outline" style="font-size:.73rem;padding:.25rem .6rem;white-space:nowrap" onclick="openAddCampModal(null)">+ Add camp</button>
      </div>
    </div>
    <div class="search-bar">
      <div class="search-wrap">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="search" id="campSearch" placeholder="Search camps‚Ä¶" />
      </div>
    </div>
    <div class="camp-grid" id="campGrid"></div>
    <div id="campMap"></div>
  </div>
</main>

<script>
// ‚îÄ‚îÄ Date helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pd(s) { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function iso(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function addD(d,n) { const r=new Date(d); r.setDate(r.getDate()+n); return r; }
function fmt(d) { return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); }
// Returns a location display string for a session if it differs from the camp,
// otherwise null (meaning: use camp location).
function sessLocStr(sess) {
  const parts = [sess.street, sess.city, [sess.state, sess.zip].filter(Boolean).join(' ')].filter(Boolean);
  return parts.length ? parts.join(', ') : null;
}
// Format a TIME string (HH:MM or HH:MM:SS) as "9am" / "3:30pm"
function fmtTime(t) {
  if(!t) return null;
  const [h, m] = t.split(':').map(Number);
  const ampm = h < 12 ? 'am' : 'pm';
  const h12 = h % 12 || 12;
  return m ? `${h12}:${String(m).padStart(2,'0')}${ampm}` : `${h12}${ampm}`;
}
function fmtCost(cost, costN, isSleep=false) {
  const suffix = isSleep ? '/session' : '/wk';
  if(costN > 0) return '~$' + costN.toLocaleString() + suffix;
  if(cost && cost !== 'See website' && cost !== '') return cost;
  return null;
}
// Returns true only for the first week a sleepaway session appears in the planner.
// Checks: session must have started after last Friday (i.e. didn't overlap previous week).
function isFirstWeekOfSession(camp, sessId, mon) {
  if(sessId == null) return true;
  const found = findSessById(camp, sessId);
  if(!found) return true;
  const prevFri = iso(addD(pd(mon), -3));
  return pd(found.sess.s) > pd(prevFri);
}
function nextMon(d) {
  const r=new Date(d), day=r.getDay();
  if(day===1) return r;
  r.setDate(r.getDate()+(day===0?1:8-day));
  return r;
}

// July 4, 2026 falls on Saturday; observed Friday July 3
const HOLS = {'2026-07-03':'‚ö° Jul 4 obs.','2026-07-04':'‚ö° Jul 4'};
function weekHol(mon,fri) {
  let d=new Date(pd(mon)); const f=pd(fri);
  while(d<=f){ const k=iso(d); if(HOLS[k]) return HOLS[k]; d=addD(d,1); }
  return null;
}
function genWeeks(lastS,firstS) {
  if(!lastS||!firstS) return [];
  const start=nextMon(addD(pd(lastS),1));
  let endMon=new Date(pd(firstS));
  const day=endMon.getDay();
  endMon.setDate(endMon.getDate()-(day===0?6:day-1));
  if(addD(endMon,4)>=pd(firstS)) endMon.setDate(endMon.getDate()-7);
  const weeks=[]; let d=new Date(start);
  while(d<=endMon){ weeks.push({mon:iso(d),fri:iso(addD(d,4))}); d=addD(d,7); }
  return weeks;
}

// ‚îÄ‚îÄ Camp data loaded from Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let CAMPS = [];

// ‚îÄ‚îÄ Custom camp helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function allCamps() { return [...CAMPS, ...S.customCamps]; }
const CUSTOM_COLORS = ['#0369a1','#7c3aed','#059669','#d97706','#dc2626','#0891b2','#be185d','#16a34a'];

// ‚îÄ‚îÄ App state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  kids: [
    { name:"Child 1", lastDay:"2026-06-03", firstDay:"2026-08-17", age:"", consider:{}, planned:{} },
    { name:"Child 2", lastDay:"2026-06-03", firstDay:"2026-08-17", age:"", consider:{}, planned:{} }
  ],
  activeKid: 0, variant: null, customCamps: [], mapView: false, vacation: {}, focusedCamp: null,
  slFilter:"", actFilter:"", q:"", selWeek:null, expandCard:null, appFilter:"", virtFilter:"",
  zipFilter:"", distFilter:"", _userLat:null, _userLng:null,
  profile: { homeAddress:'', workAddress:'' },
  household: null,   // { id, ownerId, isOwner } | null
  group: null        // { id, name, inviteCode, members:[{userId,displayName,planData}] } | null
};
let WEEKS = [];
let _pendingInvite = null;
// Extract invite token from URL on page load
_pendingInvite = new URLSearchParams(location.search).get('invite');

// ‚îÄ‚îÄ Kid colors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KID_COLORS = ['#2563eb','#0891b2','#7c3aed','#059669'];

// ‚îÄ‚îÄ Week generation ‚Äî union of all kids ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genAllWeeks() {
  const monSet = new Set();
  S.kids.forEach(k => genWeeks(k.lastDay, k.firstDay).forEach(w => monSet.add(w.mon)));
  return [...monSet].sort().map(mon => ({ mon, fri: iso(addD(pd(mon),4)) }));
}
function kidHasWeek(kidIdx, weekMon) {
  const k = S.kids[kidIdx];
  return genWeeks(k.lastDay, k.firstDay).some(w => w.mon === weekMon);
}

// ‚îÄ‚îÄ Availability ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function campAvail(camp, mon, fri) {
  const wm=pd(mon), wf=pd(fri);
  if(!camp.sleep) {
    if(camp.sessions?.length) return camp.sessions.some(s => pd(s.s)<=wf && pd(s.e)>=wm);
    if(!camp.range) return true; // custom day camp with no dates = always available
    return wm>=pd(camp.range.s) && wm<=pd(camp.range.e);
  }
  if(!camp.sessions?.length) return true; // custom sleepaway with no sessions = always available
  return camp.sessions.some(s => pd(s.s)<=wf && pd(s.e)>=wm);
}
// Returns {sess, loc} for the session overlapping [mon,fri], or null.
function findSessById(camp, sessId) {
  for (const loc of camp.locations || []) {
    const sess = loc.sessions.find(s => s.id === sessId);
    if (sess) return { sess, loc };
  }
  return null;
}
function getSessForWeek(camp, mon, fri) {
  if(!camp.sleep && !camp.sessions?.length) return null;
  const wm=pd(mon), wf=pd(fri);
  for (const loc of camp.locations || []) {
    const sess = loc.sessions.find(s => pd(s.s)<=wf && pd(s.e)>=wm);
    if (sess) return { sess, loc };
  }
  return null;
}
function haversineMi(lat1, lng1, lat2, lng2) {
  const R = 3958.8, toR = Math.PI/180;
  const dLat = (lat2-lat1)*toR, dLng = (lng2-lng1)*toR;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*toR)*Math.cos(lat2*toR)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
async function geocodeZip(zip) {
  if(!/^\d{5}$/.test(zip)) { S._userLat=null; S._userLng=null; renderCamps(); return; }
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&countrycodes=us&format=json&limit=1`,
      {headers:{'Accept-Language':'en'}});
    const d = await r.json();
    if(d[0]) { S._userLat=parseFloat(d[0].lat); S._userLng=parseFloat(d[0].lon); }
    else { S._userLat=null; S._userLng=null; }
  } catch(e) { S._userLat=null; S._userLng=null; }
  renderCamps();
}
function campPassesFilters(c) {
  const age = S.kids[S.activeKid].age;
  if(age) {
    const ageNum = parseInt(age);
    const sessWithAge = c.sessions.filter(s => s.ageMin!=null || s.ageMax!=null);
    if(sessWithAge.length) {
      if(!sessWithAge.some(s=>(s.ageMin==null||ageNum>=s.ageMin)&&(s.ageMax==null||ageNum<=s.ageMax))) return false;
    } else {
      if(c.ageMin && ageNum<c.ageMin) return false;
      if(c.ageMax && ageNum>c.ageMax) return false;
    }
  }
  if(S.slFilter==='day' && c.sleep) return false;
  if(S.slFilter==='sleep' && !c.sleep) return false;
  if(S.virtFilter) {
    const wantVirt = S.virtFilter === 'virtual';
    const sessWithFlag = c.sessions.filter(s => s.virtual != null);
    if(sessWithFlag.length) {
      if(!sessWithFlag.some(s => s.virtual === wantVirt)) return false;
    } else {
      if(c.virtual !== wantVirt) return false;
    }
  }
  const ctags = c.tags || (c.type||'').split(',').map(t=>t.trim()).filter(Boolean);
  if(S.actFilter && !ctags.includes(S.actFilter)) return false;
  if(S.appFilter==='apply' && !c.appRequired) return false;
  if(S.appFilter==='reg' && c.appRequired) return false;
  if(S._userLat!=null && S.distFilter) {
    const maxMi = parseFloat(S.distFilter);
    const locs = c.locations || [];
    const locsWithCoords = locs.filter(l => l.lat!=null && l.lng!=null);
    if(locsWithCoords.length && !locsWithCoords.some(l => haversineMi(S._userLat,S._userLng,l.lat,l.lng)<=maxMi)) return false;
  }
  const locStr = (c.locations||[]).map(l=>[l.name,l.city,l.state].filter(Boolean).join(' ')).join(' ') || c.loc;
  if(S.q && !`${c.name} ${c.desc} ${locStr} ${ctags.join(' ')}`.toLowerCase().includes(S.q.toLowerCase())) return false;
  return true;
}
function getFiltered() {
  return allCamps().filter(c => {
    if(!campPassesFilters(c)) return false;
    if(S.selWeek) {
      const fri=iso(addD(pd(S.selWeek),4));
      return campAvail(c, S.selWeek, fri);
    }
    return true;
  });
}

// ‚îÄ‚îÄ Status checks ‚Äî use activeKid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isSessionConsidering(campId, sessId) {
  const k = S.kids[S.activeKid];
  return Object.values(k.consider).some(arr => arr.some(e => e.campId===campId && e.sessId===sessId));
}
function isDayWeekConsidering(campId, weekMon) {
  const k = S.kids[S.activeKid];
  return (k.consider[weekMon]||[]).some(e => e.campId===campId);
}
function isSessionPlanned(campId, sessId) {
  const k = S.kids[S.activeKid];
  return Object.values(k.planned).some(e => e.campId===campId && e.sessId===sessId);
}
function isDayWeekPlanned(campId, weekMon) {
  const k = S.kids[S.activeKid];
  return k.planned[weekMon]?.campId===campId;
}

// ‚îÄ‚îÄ Add to consideration ‚Äî uses activeKid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addSessionToConsider(campId, sessId, locationId, locationName) {
  const k = S.kids[S.activeKid];
  const camp=allCamps().find(c=>c.id===campId);
  if(!camp||!camp.sleep) return;
  const found=findSessById(camp, sessId);
  if(!found) return;
  const {sess}=found;
  const ss=pd(sess.s), se=pd(sess.e);
  WEEKS.forEach(w => {
    const wm=pd(w.mon), wf=pd(w.fri);
    if(ss<=wf && se>=wm) {
      if(!k.consider[w.mon]) k.consider[w.mon]=[];
      if(!k.consider[w.mon].some(e=>e.campId===campId&&e.sessId===sessId))
        k.consider[w.mon].push({campId,sessId,locationId,locationName,color:camp.color,name:camp.name});
    }
  });
  renderAll();
}
function addDayWeekToConsider(campId, weekMon) {
  const k = S.kids[S.activeKid];
  const camp=allCamps().find(c=>c.id===campId);
  if(!camp) return;
  if(!k.consider[weekMon]) k.consider[weekMon]=[];
  if(!k.consider[weekMon].some(e=>e.campId===campId))
    k.consider[weekMon].push({campId,sessId:null,locationId:null,locationName:null,color:camp.color,name:camp.name});
  renderAll();
}

// ‚îÄ‚îÄ Remove from consideration ‚Äî uses activeKid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function removeSessionFromConsider(campId, sessId) {
  const k = S.kids[S.activeKid];
  Object.keys(k.consider).forEach(key=>{
    k.consider[key]=k.consider[key].filter(e=>!(e.campId===campId&&e.sessId===sessId));
    if(!k.consider[key].length) delete k.consider[key];
  });
  renderAll();
}
function removeDayWeekFromConsider(campId, weekMon) {
  const k = S.kids[S.activeKid];
  if(k.consider[weekMon]) {
    k.consider[weekMon]=k.consider[weekMon].filter(e=>e.campId!==campId);
    if(!k.consider[weekMon].length) delete k.consider[weekMon];
  }
  renderAll();
}

// ‚îÄ‚îÄ Promote to planned ‚Äî uses activeKid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function promoteSessionToPlanned(campId, sessId, locationId, locationName) {
  const k = S.kids[S.activeKid];
  const camp=allCamps().find(c=>c.id===campId);
  if(!camp||!camp.sleep) return;
  const found=findSessById(camp, sessId);
  if(!found) return;
  const {sess}=found;
  const ss=pd(sess.s), se=pd(sess.e);
  WEEKS.forEach(w => {
    const wm=pd(w.mon), wf=pd(w.fri);
    if(ss<=wf && se>=wm) {
      k.planned[w.mon]={campId,sessId,locationId,locationName,color:camp.color,name:camp.name};
      if(k.consider[w.mon]) {
        k.consider[w.mon]=k.consider[w.mon].filter(e=>!(e.campId===campId&&e.sessId===sessId));
        if(!k.consider[w.mon].length) delete k.consider[w.mon];
      }
    }
  });
  renderAll();
}
function promoteDayWeekToPlanned(campId, weekMon) {
  const k = S.kids[S.activeKid];
  const camp=allCamps().find(c=>c.id===campId);
  if(!camp) return;
  k.planned[weekMon]={campId,sessId:null,locationId:null,locationName:null,color:camp.color,name:camp.name};
  if(k.consider[weekMon]) {
    k.consider[weekMon]=k.consider[weekMon].filter(e=>e.campId!==campId);
    if(!k.consider[weekMon].length) delete k.consider[weekMon];
  }
  renderAll();
}

// ‚îÄ‚îÄ Remove from planned ‚Äî uses activeKid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function removeSessionFromPlanned(campId, sessId) {
  const k = S.kids[S.activeKid];
  Object.keys(k.planned).forEach(key=>{
    if(k.planned[key].campId===campId&&k.planned[key].sessId===sessId) delete k.planned[key];
  });
  renderAll();
}
function removeDayWeekFromPlanned(weekMon) {
  const k = S.kids[S.activeKid];
  delete k.planned[weekMon];
  renderAll();
}

// ‚îÄ‚îÄ Week panel chip actions ‚Äî explicit kidIdx ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function promoteConsiderChip(weekMon, campId, sessId, kidIdx) {
  const k = S.kids[kidIdx];
  const camp = allCamps().find(c=>c.id===campId);
  if(!camp) return;
  if(camp.sleep && sessId != null) {
    const found=findSessById(camp, sessId);
    if(!found) return;
    const {sess,loc}=found;
    const ss=pd(sess.s), se=pd(sess.e);
    WEEKS.forEach(w => {
      const wm=pd(w.mon), wf=pd(w.fri);
      if(ss<=wf && se>=wm) {
        k.planned[w.mon]={campId,sessId,locationId:loc.id,locationName:loc.name,color:camp.color,name:camp.name};
        if(k.consider[w.mon]) {
          k.consider[w.mon]=k.consider[w.mon].filter(e=>!(e.campId===campId&&e.sessId===sessId));
          if(!k.consider[w.mon].length) delete k.consider[w.mon];
        }
      }
    });
  } else {
    k.planned[weekMon]={campId,sessId:null,locationId:null,locationName:null,color:camp.color,name:camp.name};
    if(k.consider[weekMon]) {
      k.consider[weekMon]=k.consider[weekMon].filter(e=>e.campId!==campId);
      if(!k.consider[weekMon].length) delete k.consider[weekMon];
    }
  }
  renderAll();
}
function removeConsiderChip(weekMon, campId, sessId, kidIdx) {
  const k = S.kids[kidIdx];
  const camp = allCamps().find(c=>c.id===campId);
  if(!camp) return;
  if(camp.sleep && sessId != null) {
    Object.keys(k.consider).forEach(key=>{
      k.consider[key]=k.consider[key].filter(e=>!(e.campId===campId&&e.sessId===sessId));
      if(!k.consider[key].length) delete k.consider[key];
    });
  } else {
    if(k.consider[weekMon]) {
      k.consider[weekMon]=k.consider[weekMon].filter(e=>e.campId!==campId);
      if(!k.consider[weekMon].length) delete k.consider[weekMon];
    }
  }
  renderAll();
}
function removePlannedChip(weekMon, kidIdx) {
  const k = S.kids[kidIdx];
  const e = k.planned[weekMon];
  if(!e) return;
  const camp = allCamps().find(c=>c.id===e.campId);
  if(camp && camp.sleep && e.sessId != null) {
    Object.keys(k.planned).forEach(key=>{
      if(k.planned[key].campId===e.campId&&k.planned[key].sessId===e.sessId) delete k.planned[key];
    });
  } else {
    delete k.planned[weekMon];
  }
  renderAll();
}

// ‚îÄ‚îÄ Week-select flow ‚Äî adds to activeKid's consideration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToPlan(campId, sessId) {
  if(!S.selWeek) return;
  const k = S.kids[S.activeKid];
  const camp=allCamps().find(c=>c.id===campId);
  if(!camp) return;
  if(!camp.sleep) {
    if(!k.consider[S.selWeek]) k.consider[S.selWeek]=[];
    if(!k.consider[S.selWeek].some(e=>e.campId===campId))
      k.consider[S.selWeek].push({campId,sessId:null,locationId:null,locationName:null,color:camp.color,name:camp.name});
  } else {
    const found=sessId!=null?findSessById(camp,sessId):null;
    if(!found) return;
    const {sess,loc}=found;
    const ss=pd(sess.s), se=pd(sess.e);
    WEEKS.forEach(w => {
      const wm=pd(w.mon), wf=pd(w.fri);
      if(ss<=wf && se>=wm) {
        if(!k.consider[w.mon]) k.consider[w.mon]=[];
        if(!k.consider[w.mon].some(e=>e.campId===campId&&e.sessId===sessId))
          k.consider[w.mon].push({campId,sessId,locationId:loc.id,locationName:loc.name,color:camp.color,name:camp.name});
      }
    });
  }
  S.selWeek=null;
  renderAll();
}
function clearPlan() {
  if(confirm('Clear the entire summer plan for both kids?')) {
    S.kids.forEach(k => { k.consider={}; k.planned={}; });
    S.vacation = {};
    renderAll();
  }
}
function toggleVacation(mon) {
  if(S.vacation[mon]) { delete S.vacation[mon]; }
  else { S.vacation[mon] = true; }
  renderAll();
}

// ‚îÄ‚îÄ Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSummary() {
  const el = document.getElementById('summary');
  if(!WEEKS.length) { el.innerHTML=''; return; }
  const kidColors = KID_COLORS;
  let hasAny = false;
  const rows = S.kids.map((k, kidIdx) => {
    const kidWeeks = WEEKS.filter(w => kidHasWeek(kidIdx, w.mon));
    const total = kidWeeks.length;
    if(!total) return '';
    const plannedCount = kidWeeks.filter(w => k.planned[w.mon]).length;
    const considerCount = kidWeeks.filter(w => !k.planned[w.mon] && (k.consider[w.mon]||[]).length>0).length;
    const openCount = total - plannedCount - considerCount;
    const seen = new Set(); let cost = 0;
    Object.values(k.planned).forEach(e => {
      const key=`${e.campId}-${e.sessId}`;
      if(!seen.has(key)){ seen.add(key); const c=allCamps().find(x=>x.id===e.campId); if(c){ const found=e.sessId!=null?findSessById(c,e.sessId):null; cost+=(found?.sess?.costN??c.costN)||0; } }
    });
    if(plannedCount>0||considerCount>0) hasAny=true;
    return `<div class="sum-kid-row">
      <span class="sum-kid-label" style="color:${kidColors[kidIdx]}">${k.name}:</span>
      <span class="sum-stat green"><strong>${plannedCount}</strong>/${total} planned</span>
      ${considerCount>0?`<span class="sum-stat amber"><strong>${considerCount}</strong> considering</span>`:''}
      <span class="sum-stat"><strong>${openCount}</strong> open</span>
      ${cost>0?`<span class="sum-stat green">~<strong>$${cost.toLocaleString()}</strong></span>`:''}
    </div>`;
  }).join('');
  el.innerHTML = rows + (hasAny ? `<div class="sum-actions"><button class="clear-btn" onclick="clearPlan()">Clear All</button></div>` : '');
}

// ‚îÄ‚îÄ Render weeks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeeks() {
  const el = document.getElementById('weekList');
  if(!WEEKS.length) {
    el.innerHTML='<div class="week-empty">Enter school dates above to see your summer weeks.</div>';
    return;
  }
  el.innerHTML = WEEKS.map((w,i) => {
    const mon=pd(w.mon), fri=pd(w.fri);
    const isSel = S.selWeek===w.mon;
    const hol = weekHol(w.mon, w.fri);
    const isVacation = !!S.vacation[w.mon];
    const multiKid = S.kids.length > 1;

    let kidsHtml;
    if(isVacation) {
      kidsHtml = `<span class="wk-vac-pill">üèñ Vacation</span>`;
    } else {
      kidsHtml = S.kids.map((k, kidIdx) => {
        const lbl = multiKid ? `<span class="wk-kid-lbl" style="color:${KID_COLORS[kidIdx%4]}">${k.name}</span>` : '';
        if(!kidHasWeek(kidIdx, w.mon)) {
          return `<div class="wk-col k${kidIdx}-col">${lbl}<span class="wk-na">‚Äî</span></div>`;
        }
        const considers = k.consider[w.mon] || [];
        const p = k.planned[w.mon];
        let chips = [];
        considers.forEach(e => {
          const cc = allCamps().find(c=>c.id===e.campId);
          const showCost = cc && isFirstWeekOfSession(cc, e.sessId, w.mon);
          const cSess = e.sessId != null ? findSessById(cc, e.sessId)?.sess : null;
          const ccost = showCost ? fmtCost(cSess?.cost ?? cc.cost, cSess?.costN ?? cc.costN, cc.sleep) : null;
          chips.push(`<div class="wk-chip-consider" onclick="event.stopPropagation();showCampCard(${e.campId})" style="cursor:pointer" title="View camp info"><span>${e.name}</span><button class="wk-promote" onclick="event.stopPropagation();promoteConsiderChip('${w.mon}',${e.campId},${e.sessId},${kidIdx})" title="Mark as planned">‚Üí</button><button class="wk-rm-consider" onclick="event.stopPropagation();removeConsiderChip('${w.mon}',${e.campId},${e.sessId},${kidIdx})" title="Remove">‚úï</button></div>${ccost?`<span style="font-size:.61rem;color:var(--muted);font-weight:600;text-align:right;padding-right:.1rem">${ccost}</span>`:''}`);
        });
        if(p) {
          const pc = allCamps().find(c=>c.id===p.campId);
          const showCost = pc && isFirstWeekOfSession(pc, p.sessId, w.mon);
          const pSess = p.sessId != null ? findSessById(pc, p.sessId)?.sess : null;
          const pcost = showCost ? fmtCost(pSess?.cost ?? pc.cost, pSess?.costN ?? pc.costN, pc.sleep) : null;
          chips.push(`<div class="wk-chip" style="background:${p.color};cursor:pointer" onclick="event.stopPropagation();showCampCard(${p.campId})" title="View camp info"><span>${p.name}</span><button class="wk-rm" onclick="event.stopPropagation();removePlannedChip('${w.mon}',${kidIdx})" title="Remove">‚úï</button></div>${pcost?`<span style="font-size:.61rem;color:var(--muted);font-weight:600;text-align:right;padding-right:.1rem">${pcost}</span>`:''}`);
        }
        if(!chips.length) chips.push(`<span class="wk-open">${(isSel&&S.activeKid===kidIdx)?'‚ñ≤':'Open ‚ñæ'}</span>`);
        return `<div class="wk-col k${kidIdx}-col" onclick="event.stopPropagation();selWeekKid('${w.mon}',${kidIdx})">${lbl}<div class="wk-col-chips">${chips.join('')}</div></div>`;
      }).join('');
    }

    let cls = ['week-item'];
    if(isSel) cls.push('selected');
    if(isVacation) cls.push('vacation');

    // Friend initials for this week
    let friendInitials = '';
    if(S.group?.members?.length) {
      const FRIEND_COLORS = ['#7c3aed','#059669','#d97706','#dc2626','#0891b2','#be185d'];
      const circles = S.group.members.map((member, mi) => {
        const pd2 = member.planData;
        if(!pd2) return null;
        const allKidsData = pd2.kids || [];
        const hasActivity = allKidsData.some(k =>
          (k.planned && k.planned[w.mon]) || (k.consider && (k.consider[w.mon]||[]).length > 0)
        );
        if(!hasActivity) return null;
        const initials = member.displayName.trim()[0].toUpperCase();
        const color = FRIEND_COLORS[mi % FRIEND_COLORS.length];
        return `<span class="wk-friend-init" style="background:${color}" title="${member.displayName}">${initials}</span>`;
      }).filter(Boolean);
      if(circles.length) friendInitials = `<div class="wk-friends">${circles.join('')}</div>`;
    }

    return `<div class="${cls.join(' ')}" onclick="selWeek('${w.mon}')">
      <div class="wk-num" onclick="event.stopPropagation();toggleVacation('${w.mon}')" title="${isVacation?'Remove vacation block':'Block this week for vacation'}">${isVacation?'üèñ':`W${i+1}`}</div>
      <div class="wk-dates"><div class="d">${fmt(mon)} ‚Äì ${fmt(fri)}</div>${hol?`<div class="hol">‚ö† ${hol}</div>`:''}</div>
      ${friendInitials}
      <div class="wk-kids-stack">${kidsHtml}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Day camp weeks ‚Äî filtered to activeKid's summer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getDayCampWeeks(camp) {
  if(!camp.range) return WEEKS.filter(w => kidHasWeek(S.activeKid, w.mon));
  const rs=pd(camp.range.s), re=pd(camp.range.e);
  return WEEKS.filter(w => kidHasWeek(S.activeKid, w.mon) && pd(w.mon)>=rs && pd(w.mon)<=re);
}

// ‚îÄ‚îÄ Render camps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCamps() {
  const grid = document.getElementById('campGrid');
  const titleEl = document.getElementById('campsTitle');
  const countEl = document.getElementById('campCount');
  const kidTabsEl = document.getElementById('kidTabs');

  if (!_campsLoaded) {
    grid.innerHTML = `<div class="no-results">
      <div style="font-size:1.5rem;margin-bottom:.4rem">‚è≥</div>Loading camps‚Ä¶
    </div>`;
    return;
  }

  // Update kid selector tabs
  if(S.selWeek) {
    kidTabsEl.style.display = 'flex';
    kidTabsEl.innerHTML = S.kids.map((k, i) => {
      const isActive = S.activeKid===i;
      return `<button class="kid-tab k${i%4}${isActive?' active':''}" onclick="setActiveKid(${i})">${k.name}</button>`;
    }).join('');
  } else {
    kidTabsEl.style.display = 'none';
    kidTabsEl.innerHTML = '';
  }

  const filtered = S.focusedCamp !== null
    ? allCamps().filter(c => c.id === S.focusedCamp)
    : getFiltered();
  const isFocused = S.focusedCamp !== null && filtered.length > 0;
  if(isFocused) {
    kidTabsEl.style.display = 'none'; kidTabsEl.innerHTML = '';
    S.expandCard = S.focusedCamp;
    titleEl.textContent = 'Camp Info';
    countEl.textContent = '';
  } else {
    titleEl.textContent = S.selWeek ? `${fmt(pd(S.selWeek))} ‚Äì ${fmt(addD(pd(S.selWeek),4))}` : 'All Camps';
    // Count cards (multi-location camps expand to one card per location)
    const _cardCount = filtered.reduce((n,c) => {
      const nl = (c.locations||[]).filter(l=>l.name&&l.sessions.length);
      return n + (nl.length > 1 ? nl.length : 1);
    }, 0);
    countEl.textContent = `${_cardCount} camp${_cardCount!==1?'s':''}`;
  }

  const mapEl = document.getElementById('campMap');

  if(S.selWeek && S.vacation[S.selWeek]) {
    grid.style.display = ''; mapEl.style.display = 'none';
    grid.innerHTML = `<div class="no-results" style="padding-top:3rem">
      <div style="font-size:2.5rem;margin-bottom:.6rem">üèñ</div>
      <div style="font-weight:700;font-size:1rem;margin-bottom:.35rem">Vacation week</div>
      <div style="color:var(--muted);font-size:.83rem;margin-bottom:1.25rem">This week is blocked for family vacation.</div>
      <button class="btn btn-outline" onclick="toggleVacation('${S.selWeek}')">Remove vacation block</button>
    </div>`;
    return;
  }

  grid.style.display = S.mapView ? 'none' : '';
  mapEl.style.display = S.mapView ? 'block' : 'none';
  if(S.mapView) { renderMap(filtered); return; }

  if(!filtered.length) {
    grid.innerHTML=`<div class="no-results"><div style="font-size:1.5rem;margin-bottom:.4rem">üîç</div>No camps match your filters.</div>`;
    return;
  }

  const backBtn = isFocused ? `<div style="padding:.3rem 0 .65rem"><button onclick="clearFocusedCamp()" style="background:none;border:none;color:var(--primary);font-size:.83rem;font-weight:700;cursor:pointer;padding:0">‚Üê All camps</button></div>` : '';

  // Expand multi-location camps into per-location cards
  const cards = [];
  for (const camp of filtered) {
    const _kidAge = parseInt(S.kids[S.activeKid].age) || 0;
    const namedLocs = (camp.locations || []).filter(l => {
      if (!l.name || !l.sessions.length) return false;
      if (_kidAge) {
        const sw = l.sessions.filter(s => s.ageMin!=null || s.ageMax!=null);
        if (sw.length && !sw.some(s=>(s.ageMin==null||_kidAge>=s.ageMin)&&(s.ageMax==null||_kidAge<=s.ageMax))) return false;
      }
      if (S._userLat!=null && S.distFilter && l.lat!=null && l.lng!=null) {
        if (haversineMi(S._userLat,S._userLng,l.lat,l.lng) > parseFloat(S.distFilter)) return false;
      }
      return true;
    });
    if (namedLocs.length > 1) {
      namedLocs.forEach(loc => cards.push({ camp, loc }));
    } else {
      cards.push({ camp, loc: null });
    }
  }

  grid.innerHTML = backBtn + cards.map(({camp, loc}) => {
    const fri = S.selWeek ? iso(addD(pd(S.selWeek),4)) : null;
    const cardKey = loc ? 'loc_' + loc.id : camp.id;
    const isExp = isFocused || S.expandCard === cardKey;
    let sessInfo='', sessForWeek=null;
    if(S.selWeek) {
      if(loc) {
        const wm=pd(S.selWeek), wf=pd(fri);
        const sess = loc.sessions.find(s => pd(s.s)<=wf && pd(s.e)>=wm);
        if(sess) sessForWeek = {sess, loc};
      } else {
        sessForWeek = getSessForWeek(camp, S.selWeek, fri);
      }
      if(sessForWeek) {
        const {sess:s}=sessForWeek;
        sessInfo=`<div class="session-pill">üìÖ ${fmt(pd(s.s))} ‚Äì ${fmt(pd(s.e))} &nbsp;¬∑&nbsp; ${s.lbl}</div>`;
      }
    }
    const verifiedBadge = camp.custom ? '' : (
      camp.comingSoon
        ? `<div class="coming-soon-pill">üìÖ 2026 dates coming soon</div>`
        : camp.verified
          ? `<div class="verified-pill">‚úì 2026 dates verified</div>`
          : `<div class="est-pill">~ 2026 dates estimated</div>`);
    let btn;
    if(S.selWeek){
      const avail = loc
        ? (() => { const wm=pd(S.selWeek),wf=pd(fri); return loc.sessions.some(s=>pd(s.s)<=wf&&pd(s.e)>=wm); })()
        : campAvail(camp,S.selWeek,fri);
      btn=avail
        ?`<button class="btn btn-solid" onclick="event.stopPropagation();addToPlan(${camp.id},${sessForWeek?.sess?.id??null})">+ Consider</button>`
        :`<button class="btn btn-solid" disabled onclick="event.stopPropagation()">Not available</button>`;
    } else {
      const campInfoLink = (loc?.url||camp.url) ? `<a class="btn btn-outline" href="${loc?.url||camp.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Camp Info ‚Üí</a>` : '';
      btn = campInfoLink || `<span></span>`;
    }
    let sessionsSection='';
    const locsForSess = loc ? [loc] : camp.locations;
    const _hasSleepSessions = locsForSess?.some(l=>l.sessions.length);
    if(_hasSleepSessions) {
      const _multiLoc = !loc && (locsForSess.filter(l=>l.sessions.length).length > 1 || locsForSess.some(l=>l.name));
      sessionsSection=`<div class="sessions-section"><div class="sessions-section-title">2026 Sessions</div><ul class="sessions-list">${
        locsForSess.flatMap(l=>{
          if(!l.sessions.length) return [];
          const locHeader = (_multiLoc && l.name) ? [`<li style="list-style:none;font-size:.72rem;font-weight:700;color:var(--muted);padding:.35rem 0 .15rem;border-top:1px solid var(--border);margin-top:.25rem">üìç ${l.name}${l.loc?' ¬∑ <span style="font-weight:400">'+l.loc+'</span>':''}</li>`] : [];
          const _age = parseInt(S.kids[S.activeKid].age) || 0;
          const _visibleSess = l.sessions.filter(s => {
            if(_age && !(s.ageMin==null && s.ageMax==null) &&
               !((s.ageMin==null||_age>=s.ageMin) && (s.ageMax==null||_age<=s.ageMax))) return false;
            if(S.virtFilter==='virtual' && !s.virtual) return false;
            if(S.virtFilter==='inperson' && s.virtual) return false;
            return true;
          });
          return [...locHeader, ..._visibleSess.map(s=>{
            const considering=isSessionConsidering(camp.id,s.id);
            const planned=isSessionPlanned(camp.id,s.id);
            const timeStr = (s.startTime||s.endTime) ? ` ¬∑ ${[fmtTime(s.startTime),fmtTime(s.endTime)].filter(Boolean).join('‚Äì')}` : '';
            const deadlineStr = s.appDeadline ? `<span class="sess-deadline">Apply by ${fmt(pd(s.appDeadline))}</span>` : '';
            const virtBadge = s.virtual ? `<span style="font-size:.68rem;background:#e0f2fe;color:#0369a1;border-radius:4px;padding:.05rem .3rem;margin-left:.3rem;font-weight:600">Virtual</span>` : '';
            const label=`üìÖ ${fmt(pd(s.s))} ‚Äì ${fmt(pd(s.e))} ¬∑ ${s.lbl}${timeStr}`;
            if(planned) return `<li class="sess-planned" onclick="event.stopPropagation();removeSessionFromPlanned(${camp.id},${s.id})"><span class="sess-label">${label}${virtBadge}${deadlineStr}</span><span class="sess-action">‚úì Planned ¬∑ ‚úï</span></li>`;
            if(considering) return `<li class="sess-considering" onclick="event.stopPropagation();promoteSessionToPlanned(${camp.id},${s.id},${l.id},${JSON.stringify(l.name)})"><span class="sess-label">${label}${virtBadge}${deadlineStr}</span><span class="sess-action">‚Üí Plan <button class="sess-remove-btn" onclick="event.stopPropagation();removeSessionFromConsider(${camp.id},${s.id})">‚úï</button></span></li>`;
            return `<li onclick="event.stopPropagation();addSessionToConsider(${camp.id},${s.id},${l.id},${JSON.stringify(l.name)})"><span class="sess-label">${label}${virtBadge}${deadlineStr}</span><span class="sess-action">+ Consider</span></li>`;
          })];
        }).join('')
      }</ul></div>`;
    } else {
      const dayWeeks=getDayCampWeeks(camp);
      if(dayWeeks.length) {
        sessionsSection=`<div class="sessions-section"><div class="sessions-section-title">Weekly Schedule</div><ul class="sessions-list">${
          dayWeeks.map(w=>{
            const considering=isDayWeekConsidering(camp.id,w.mon);
            const planned=isDayWeekPlanned(camp.id,w.mon);
            if(planned) return `<li class="sess-planned" onclick="event.stopPropagation();removeDayWeekFromPlanned('${w.mon}')"><span class="sess-label">üìÖ ${fmt(pd(w.mon))} ‚Äì ${fmt(pd(w.fri))}</span><span class="sess-action">‚úì Planned ¬∑ ‚úï</span></li>`;
            if(considering) return `<li class="sess-considering" onclick="event.stopPropagation();promoteDayWeekToPlanned(${camp.id},'${w.mon}')"><span class="sess-label">üìÖ ${fmt(pd(w.mon))} ‚Äì ${fmt(pd(w.fri))}</span><span class="sess-action">‚Üí Plan <button class="sess-remove-btn" onclick="event.stopPropagation();removeDayWeekFromConsider(${camp.id},'${w.mon}')">‚úï</button></span></li>`;
            return `<li onclick="event.stopPropagation();addDayWeekToConsider(${camp.id},'${w.mon}')"><span class="sess-label">üìÖ ${fmt(pd(w.mon))} ‚Äì ${fmt(pd(w.fri))}</span><span class="sess-action">+ Consider</span></li>`;
          }).join('')
        }</ul></div>`;
      }
    }
    const expandSection = isExp ? `<div class="card-expand" style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:.4rem">
        ${(loc?.url||camp.url) ? `<a class="btn btn-outline" href="${loc?.url||camp.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Camp Info ‚Üí</a>` : ''}
      </div>
      ${camp.custom ? `<div style="display:flex;gap:.5rem">
        <button class="btn btn-outline" style="font-size:.73rem;border-color:#94a3b8;color:#64748b" onclick="event.stopPropagation();openAddCampModal(${camp.id})">‚úè Edit</button>
        <button class="btn btn-outline" style="font-size:.73rem;border-color:var(--red);color:var(--red)" onclick="event.stopPropagation();deleteCustomCamp(${camp.id})">Delete</button>
      </div>` : ''}
    </div>` : '';
    // Group friends indicator
    let groupFriendsHtml = '';
    if(S.group?.members?.length) {
      const FRIEND_COLORS = ['#7c3aed','#059669','#d97706','#dc2626','#0891b2','#be185d'];
      const indicators = [];
      S.group.members.forEach((member, mi) => {
        const pd2 = member.planData;
        if(!pd2) return;
        const allKidsData = pd2.kids || [];
        const color = FRIEND_COLORS[mi % FRIEND_COLORS.length];
        // Find weeks where this friend has this camp planned or considering
        const planned = [], considering = [];
        WEEKS.forEach((w, wi) => {
          allKidsData.forEach(k => {
            const isPlanned = k.planned && (
              camp.sleep
                ? Object.values(k.planned).some(e => e.campId === camp.id)
                : k.planned[w.mon]?.campId === camp.id
            );
            if(isPlanned && !planned.includes(`W${wi+1}`)) planned.push(`W${wi+1}`);
            const isConsidering = k.consider && (k.consider[w.mon]||[]).some(e => e.campId === camp.id);
            if(isConsidering && !considering.includes(`W${wi+1}`)) considering.push(`W${wi+1}`);
          });
        });
        // De-dup: remove considering weeks already in planned
        const considerOnly = considering.filter(w => !planned.includes(w));
        if(planned.length || considerOnly.length) {
          let parts = [];
          if(planned.length) parts.push(`<strong style="color:${color}">${member.displayName}</strong> ‚Üí ${planned.join(', ')}`);
          if(considerOnly.length) parts.push(`<strong style="color:${color}">${member.displayName}</strong> ‚Üí ${considerOnly.join(', ')} <em style="color:#94a3b8">considering</em>`);
          indicators.push(...parts);
        }
      });
      if(indicators.length) {
        groupFriendsHtml = `<div class="group-friends">üë• ${indicators.join(' ¬∑ ')}</div>`;
      }
    }
    const cardName = loc ? loc.name : camp.name;
    const locationMeta = loc
      ? [loc.city, loc.state].filter(Boolean).join(', ')
      : (camp.locations?.length > 1
          ? camp.locations.map(l=>l.name||l.city).filter(Boolean).join(', ')
          : [camp.city, camp.state].filter(Boolean).join(', ') || camp.loc || '‚Äî');
    const cardCost = loc ? (loc.sessions[0]?.cost || camp.cost) : camp.cost;
    const _cardArg = typeof cardKey === 'number' ? cardKey : "'" + cardKey + "'";

    return `<div class="card${isExp?' expanded':''}" onclick="toggleCard(${_cardArg})">
      <div class="card-bar" style="background:${camp.color}"></div>
      <div class="card-body">
        <div class="card-top">
          <div>
            <div class="card-name">${cardName}</div>
            ${loc ? `<div style="font-size:.72rem;color:var(--muted);margin-top:.1rem">${camp.name}</div>` : ''}
          </div>
          <div class="badges">
            ${camp.custom ? '<span class="badge badge-custom">Custom</span>' : ''}
            <span class="badge ${camp.sleep?'badge-sleep':'badge-day'}">${camp.sleep?'Sleepaway':'Day'}</span>
            ${(camp.tags||[camp.type]).map(t=>`<span class="badge badge-type">${t}</span>`).join('')}
            ${camp.custom ? '' : `<span class="badge ${camp.appRequired?'badge-apply':'badge-reg'}">${camp.appRequired?'‚úé Apply':'‚úì Register'}</span>`}
          </div>
          <span class="card-chevron">‚ñº</span>
        </div>
        <p class="card-desc" style="${isExp?'-webkit-line-clamp:unset;overflow:visible':''}">${camp.desc}</p>
        ${sessInfo}
        ${verifiedBadge}
        <div class="card-meta">
          <span class="mk">Ages</span><span class="mv">${camp.ageMin}‚Äì${camp.ageMax}</span>
          <span class="mk">Location</span><span class="mv">${locationMeta}</span>
          ${isExp && (loc?.street||camp.street) ? `<span class="mk">Address</span><span class="mv">${loc?.loc||camp.loc}</span>` : ''}
          ${camp.custom ? '' : `<span class="mk">Apply/info</span><span class="mv">${camp.apply}</span>`}
          ${(()=>{
            const _sd = (locsForSess||[]).flatMap(l=>l.sessions.map(s=>s.appDeadline)).filter(Boolean).sort()[0] || camp.appDeadline;
            return _sd ? `<span class="mk">Apply by</span><span class="mv" style="color:var(--red);font-weight:600">${fmt(pd(_sd))}</span>` : '';
          })()}
        </div>
        ${groupFriendsHtml}
      </div>
      ${isExp ? sessionsSection : ''}
      <div class="card-foot">
        <span class="cost">${cardCost}</span>
        ${btn}
      </div>
      ${expandSection}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Kid rows in settings (dynamic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderKidRows() {
  const el = document.getElementById('kidRows');
  el.innerHTML = S.kids.map((k, i) => {
    const color = KID_COLORS[i];
    const ageOpts = `<option value="">Any age</option>` +
      Array.from({length:15},(_,j)=>`<option value="${j+4}"${k.age==j+4?' selected':''}>Age ${j+4}</option>`).join('');
    return `<div class="kid-row" style="--kid-color:${color}">
      <div class="sg"><label>Child ${i+1} name</label>
        <input type="text" value="${k.name.replace(/"/g,'&quot;')}"
          oninput="S.kids[${i}].name=this.value||'Child ${i+1}';renderAll()" /></div>
      <div class="sg"><label>Last day of school</label>
        <input type="date" value="${k.lastDay}"
          onchange="S.kids[${i}].lastDay=this.value;S.selWeek=null;S.kids[${i}].consider={};S.kids[${i}].planned={};renderAll()" /></div>
      <div class="sg"><label>First day of school</label>
        <input type="date" value="${k.firstDay}"
          onchange="S.kids[${i}].firstDay=this.value;S.selWeek=null;S.kids[${i}].consider={};S.kids[${i}].planned={};renderAll()" /></div>
      <div class="sg"><label>Age</label>
        <select onchange="S.kids[${i}].age=this.value;renderAll()">${ageOpts}</select></div>
    </div>`;
  }).join('');
}

function setKidCount(n) {
  const cur = S.kids.length;
  if(n === cur) return;
  if(n < cur) {
    const hasPlans = S.kids.slice(n).some(k =>
      Object.keys(k.planned).length>0 || Object.keys(k.consider).length>0);
    if(hasPlans && !confirm(`Remove Child ${cur} and clear their plans?`)) return;
    S.kids = S.kids.slice(0, n);
  } else {
    for(let i=cur; i<n; i++)
      S.kids.push({name:`Child ${i+1}`,lastDay:'2026-06-03',firstDay:'2026-08-17',age:'',consider:{},planned:{}});
  }
  if(S.activeKid >= S.kids.length) S.activeKid = S.kids.length-1;
  document.querySelectorAll('#kidCountToggle .tgl').forEach((btn,i) =>
    btn.classList.toggle('active', i+1===n));
  renderKidRows();
  updatePanelWidth();
  renderAll();
}

function updatePanelWidth() {
  const widths = [340, 420, 510, 590];
  document.querySelector('main').style.gridTemplateColumns =
    `${widths[S.kids.length-1]}px 1fr`;
}

// ‚îÄ‚îÄ Custom camp modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _editingCampId = null;
let _campStyle = 'day';
let _adminCampMode = false;
let _campTags = [];
let _campLocations = []; // [{id, name, street, city, state, zip, url, _delete}]

function renderLocationRows() {
  const el = document.getElementById('cc_location_rows');
  if(!el) return;
  el.innerHTML = _campLocations.filter(l=>!l._delete).map((loc,i)=>`
    <div style="border:1px solid var(--border);border-radius:8px;padding:.6rem .75rem;margin-bottom:.5rem;background:#fafbfc">
      <div style="display:flex;gap:.5rem;margin-bottom:.35rem;align-items:center">
        <input type="text" placeholder="Location name (optional, e.g. Bay Club Gateway)"
          value="${loc.name||''}" oninput="_campLocations[${i}].name=this.value"
          style="flex:1;padding:.38rem .6rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none" />
        <button type="button" onclick="removeLocationRow(${i})"
          style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:.9rem;line-height:1;padding:.2rem .35rem" title="Remove location">‚úï</button>
      </div>
      <input type="text" placeholder="Street address" value="${loc.street||''}"
        oninput="_campLocations[${i}].street=this.value"
        style="width:100%;padding:.38rem .6rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none;margin-bottom:.35rem;box-sizing:border-box" />
      <div style="display:flex;gap:.4rem;margin-bottom:.35rem">
        <input type="text" placeholder="City" value="${loc.city||''}"
          oninput="_campLocations[${i}].city=this.value"
          style="flex:2;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none" />
        <input type="text" placeholder="ST" value="${loc.state||''}"
          oninput="_campLocations[${i}].state=this.value"
          style="width:52px;padding:.38rem .5rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none" />
        <input type="text" placeholder="ZIP" value="${loc.zip||''}"
          oninput="_campLocations[${i}].zip=this.value"
          style="width:72px;padding:.38rem .5rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none" />
      </div>
      <input type="url" placeholder="Location-specific URL (optional)" value="${loc.url||''}"
        oninput="_campLocations[${i}].url=this.value"
        style="width:100%;padding:.38rem .6rem;border:1.5px solid var(--border);border-radius:7px;font-size:.82rem;outline:none;box-sizing:border-box" />
    </div>`).join('');
}

function addLocationRow() {
  _campLocations.push({id:null,name:'',street:'',city:'',state:'',zip:'',url:'',_delete:false});
  renderLocationRows();
}

function removeLocationRow(i) {
  if(_campLocations[i].id) {
    _campLocations[i]._delete = true;
  } else {
    _campLocations.splice(i,1);
  }
  renderLocationRows();
}

async function saveLocations(campId) {
  for(const loc of _campLocations) {
    if(loc._delete && loc.id) {
      await sb.from('locations').delete().eq('id', loc.id);
    } else if(!loc._delete && loc.id) {
      await sb.from('locations').update({
        name: loc.name||null, street_address: loc.street||null,
        city: loc.city||null, state: loc.state||null,
        zip: loc.zip||null, url: loc.url||null,
      }).eq('id', loc.id);
    } else if(!loc._delete && !loc.id) {
      await sb.from('locations').insert({
        camp_id: campId, name: loc.name||null,
        street_address: loc.street||null, city: loc.city||null,
        state: loc.state||null, zip: loc.zip||null,
        url: loc.url||null, active: true,
      });
    }
  }
}

function renderCampTags() {
  const wrap = document.getElementById('cc_tags_wrap');
  const input = document.getElementById('cc_tag_input');
  // Remove existing chips
  wrap.querySelectorAll('.tag-chip').forEach(el => el.remove());
  _campTags.forEach((tag, i) => {
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.innerHTML = `${tag}<span class="tag-chip-x" onclick="removeCampTag(${i})">√ó</span>`;
    wrap.insertBefore(chip, input);
  });
  input.placeholder = _campTags.length ? '' : 'e.g. Coding, STEM, Tennis‚Ä¶';
}

function handleTagInput(e) {
  if(e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,+$/, '');
    if(val && !_campTags.includes(val)) { _campTags.push(val); renderCampTags(); }
    e.target.value = '';
  } else if(e.key === 'Backspace' && e.target.value === '' && _campTags.length) {
    _campTags.pop(); renderCampTags();
  }
}

function removeCampTag(i) {
  _campTags.splice(i, 1); renderCampTags();
}

function populateActFilter() {
  const tags = [...new Set(CAMPS.flatMap(c => c.tags || []))].sort();
  const sel = document.getElementById('actFilter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All activities</option>' +
    tags.map(t => `<option${t===cur?' selected':''}>${t}</option>`).join('');
}

function openAddCampModal(editId) {
  _editingCampId = editId ?? null;
  const isEdit = editId !== null && editId !== undefined;
  const adminLabel = _adminCampMode ? ' (Admin)' : '';
  document.getElementById('addCampModalTitle').textContent = isEdit ? `Edit Camp${adminLabel}` : (_adminCampMode ? 'Add Camp' : 'Add Custom Camp');
  document.getElementById('cc_submit').textContent = isEdit ? 'Save Changes' : (_adminCampMode ? 'Save to Database' : 'Add Camp');
  document.getElementById('cc_msg').textContent = '';
  // Show/hide location sections based on admin mode
  document.getElementById('cc_location_fields').style.display = _adminCampMode ? 'none' : '';
  document.getElementById('cc_locations_section').style.display = _adminCampMode ? '' : 'none';

  if(isEdit) {
    const c = _adminCampMode ? CAMPS.find(x=>x.id===editId) : S.customCamps.find(x=>x.id===editId);
    if(!c) return;
    document.getElementById('cc_name').value = c.name;
    document.getElementById('cc_website_url').value = c.websiteUrl || '';
    document.getElementById('cc_url').value = c.url || '';
    _campTags = [...(c.tags || (c.type||'').split(',').map(t=>t.trim()).filter(Boolean))];
    renderCampTags();
    document.getElementById('cc_age_min').value = c.ageMin || 5;
    document.getElementById('cc_age_max').value = c.ageMax || 15;
    document.getElementById('cc_cost').value = c.cost || '';
    document.getElementById('cc_street').value = c.street || '';
    document.getElementById('cc_city').value = c.city || '';
    document.getElementById('cc_state').value = c.state || '';
    document.getElementById('cc_zip').value = c.zip || '';
    document.getElementById('cc_country').value = c.country || '';
    document.getElementById('cc_desc').value = c.desc || '';
    document.getElementById('cc_all_summer').checked = !c.range;
    document.getElementById('cc_date_start').value = c.range?.s || '';
    document.getElementById('cc_date_end').value = c.range?.e || '';
    document.getElementById('cc_app_deadline').value = c.appDeadline || '';
    setCampStyle(c.sleep ? 'sleep' : 'day');
    if(_adminCampMode) {
      _campLocations = (c.locations || []).map(l => ({
        id: l.id, name: l.name||'', street: l.street||'',
        city: l.city||'', state: l.state||'', zip: l.zip||'',
        url: l.url||'', _delete: false,
      }));
      renderLocationRows();
    }
  } else {
    document.getElementById('cc_name').value = '';
    document.getElementById('cc_website_url').value = '';
    document.getElementById('cc_url').value = '';
    _campTags = []; renderCampTags();
    document.getElementById('cc_age_min').value = '5';
    document.getElementById('cc_age_max').value = '15';
    document.getElementById('cc_cost').value = '';
    document.getElementById('cc_street').value = '';
    document.getElementById('cc_city').value = '';
    document.getElementById('cc_state').value = '';
    document.getElementById('cc_zip').value = '';
    document.getElementById('cc_country').value = 'US';
    document.getElementById('cc_desc').value = '';
    document.getElementById('cc_all_summer').checked = true;
    document.getElementById('cc_date_start').value = '';
    document.getElementById('cc_date_end').value = '';
    document.getElementById('cc_app_deadline').value = '';
    setCampStyle('day');
    if(_adminCampMode) {
      _campLocations = [{id:null,name:'',street:'',city:'',state:'',zip:'',url:'',_delete:false}];
      renderLocationRows();
    }
  }
  toggleCampDateRange();
  document.getElementById('addCampModal').style.display = 'flex';
  setTimeout(() => document.getElementById('cc_name').focus(), 50);
}
function closeAddCampModal() {
  document.getElementById('addCampModal').style.display = 'none';
  _editingCampId = null;
  _adminCampMode = false;
}
function setCampStyle(style) {
  _campStyle = style;
  document.getElementById('cc_day_btn').classList.toggle('active', style==='day');
  document.getElementById('cc_sleep_btn').classList.toggle('active', style==='sleep');
}
function toggleCampDateRange() {
  const allSummer = document.getElementById('cc_all_summer').checked;
  document.getElementById('cc_dates_row').style.display = allSummer ? 'none' : 'flex';
}
function submitCustomCamp() {
  const name = document.getElementById('cc_name').value.trim();
  if(!name) { document.getElementById('cc_msg').textContent = 'Camp name is required.'; return; }
  const allSummer = document.getElementById('cc_all_summer').checked;
  let range = null;
  if(!allSummer) {
    const s = document.getElementById('cc_date_start').value;
    const e = document.getElementById('cc_date_end').value;
    if(!s || !e) { document.getElementById('cc_msg').textContent = 'Enter both start and end dates, or choose "Available all summer".'; return; }
    range = { s, e };
  }
  const isEdit = _editingCampId !== null;
  const existingColor = isEdit
    ? (_adminCampMode ? CAMPS.find(c=>c.id===_editingCampId)?.color : S.customCamps.find(c=>c.id===_editingCampId)?.color)
    : null;
  const _street  = document.getElementById('cc_street').value.trim() || null;
  const _city    = document.getElementById('cc_city').value.trim() || null;
  const _state   = document.getElementById('cc_state').value.trim() || null;
  const _zip     = document.getElementById('cc_zip').value.trim() || null;
  const _country = document.getElementById('cc_country').value.trim() || null;
  const _url     = document.getElementById('cc_url').value.trim();
  // Build synthetic location for custom camps (single location, no sessions)
  const _customLoc = {
    id: null, campId: null, name: null,
    street: _street, city: _city, state: _state, zip: _zip, country: _country, url: _url,
    get loc() {
      return [this.street, this.city, [this.state, this.zip].filter(Boolean).join(' ')]
               .filter(Boolean).join(', ') || '';
    },
    sessions: [],
  };
  const camp = {
    id: isEdit ? _editingCampId : (_adminCampMode ? null : -Date.now()),
    name,
    type: _campTags.join(','),
    tags: [..._campTags],
    sleep: _campStyle === 'sleep',
    verified: false, appRequired: false,
    desc: document.getElementById('cc_desc').value.trim(),
    ageMin: parseInt(document.getElementById('cc_age_min').value) || 4,
    ageMax: parseInt(document.getElementById('cc_age_max').value) || 17,
    range,
    apply: '',
    appDeadline: document.getElementById('cc_app_deadline').value || null,
    locations: [_customLoc],
    // Backward-compat direct fields (read-through to location)
    get street() { return this.locations[0]?.street || null; },
    get city()   { return this.locations[0]?.city || null; },
    get state()  { return this.locations[0]?.state || null; },
    get loc()    { return this.locations[0]?.loc || ''; },
    get sessions() { return []; },
    cost: document.getElementById('cc_cost').value.trim() || 'See website', costN: 0,
    websiteUrl: document.getElementById('cc_website_url').value.trim() || null,
    url: _url,
    color: existingColor || CUSTOM_COLORS[S.customCamps.length % CUSTOM_COLORS.length],
    custom: !_adminCampMode
  };
  if(_adminCampMode) {
    saveAdminCamp(camp);
    return;
  }
  if(isEdit) {
    const idx = S.customCamps.findIndex(c=>c.id===_editingCampId);
    if(idx >= 0) S.customCamps[idx] = camp;
  } else {
    S.customCamps.push(camp);
  }
  closeAddCampModal();
  renderAll();
}
function deleteCustomCamp(id) {
  if(!confirm('Remove this custom camp and clear it from all plans?')) return;
  S.kids.forEach(k => {
    Object.keys(k.consider).forEach(mon => {
      k.consider[mon] = k.consider[mon].filter(e => e.campId !== id);
      if(!k.consider[mon].length) delete k.consider[mon];
    });
    Object.keys(k.planned).forEach(mon => {
      if(k.planned[mon].campId === id) delete k.planned[mon];
    });
  });
  S.customCamps = S.customCamps.filter(c => c.id !== id);
  renderAll();
}

// ‚îÄ‚îÄ Admin camp management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAdminCampsModal() {
  document.getElementById('adminCampsModal').style.display = 'flex';
  renderAdminCampsList();
}
function closeAdminCampsModal() {
  document.getElementById('adminCampsModal').style.display = 'none';
}
function renderAdminCampsList() {
  const el = document.getElementById('adminCampsList');
  if(!el) return;
  if(!CAMPS.length) {
    el.innerHTML = '<p style="padding:.75rem;font-size:.85rem;color:var(--muted)">No camps loaded.</p>';
    return;
  }
  el.innerHTML = CAMPS.map(c => `
    <div style="display:flex;align-items:center;gap:.6rem;padding:.55rem .4rem;border-bottom:1px solid var(--border)">
      <div style="width:6px;height:6px;border-radius:50%;background:${c.color};flex-shrink:0"></div>
      <div style="flex:1;min-width:0">
        <div style="font-size:.84rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name}</div>
        <div style="font-size:.72rem;color:var(--muted)">${(c.tags||[c.type]).join(', ')} ¬∑ ${c.sleep?'Sleepaway':'Day'} ¬∑ ID ${c.id}</div>
      </div>
      <button class="btn btn-outline" style="padding:.18rem .45rem;font-size:.71rem;flex-shrink:0"
        onclick="openAdminEditCamp(${c.id})">Edit</button>
      <button class="btn btn-outline" style="padding:.18rem .45rem;font-size:.71rem;flex-shrink:0;border-color:var(--red);color:var(--red)"
        onclick="deactivateCamp(${c.id})">Deactivate</button>
    </div>`).join('');
}
function openAdminAddCamp() {
  _adminCampMode = true;
  closeAdminCampsModal();
  openAddCampModal(null);
}
function openAdminEditCamp(id) {
  _adminCampMode = true;
  closeAdminCampsModal();
  openAddCampModal(id);
}
async function deactivateCamp(id) {
  if(!confirm('Deactivate this camp? It will be hidden from all users until reactivated.')) return;
  await sb.from('camps').update({ active: false }).eq('id', id);
  await loadCamps();
  openAdminCampsModal();
}
async function saveAdminCamp(camp) {
  const btn = document.getElementById('cc_submit');
  btn.disabled = true;
  btn.textContent = 'Saving‚Ä¶';
  const row = {
    ...(camp.id ? { id: camp.id } : {}),
    name: camp.name, type: (camp.tags||[]).join(',') || camp.type || '', sleep: camp.sleep,
    app_required: camp.appRequired || false,
    description: camp.desc || null,
    age_min: camp.ageMin, age_max: camp.ageMax,
    apply_info: camp.apply || null,
    app_deadline: camp.appDeadline || null,
    website_url: camp.websiteUrl || null,
    url: camp.url || null,
    color: camp.color || '#0369a1',
    date_range: camp.range || null,
    active: true,
  };
  const { data: savedRow, error } = await sb.from('camps').upsert(row, { onConflict: 'id' }).select('id').single();
  if(error) {
    document.getElementById('cc_msg').textContent = 'Save failed: ' + error.message;
    btn.disabled = false;
    btn.textContent = 'Save to Database';
    return;
  }
  const campId = savedRow?.id || camp.id;
  if(campId) await saveLocations(campId);
  closeAddCampModal();
  await loadCamps();
  openAdminCampsModal();
}

// ‚îÄ‚îÄ Map view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COORDS = {
  // SF day camps
  1:[37.8686,-122.5054], 2:[37.7672,-122.4508], 3:[37.7694,-122.4862],
  4:[37.7680,-122.3916], 5:[37.7614,-122.4103], 6:[37.7759,-122.4203],
  7:[37.7749,-122.4194], 8:[37.7605,-122.4610], 9:[37.7760,-122.4150],
  10:[37.7083,-122.4415],11:[37.7857,-122.4011],12:[37.7730,-122.4180],
  // Sleepaway - Northern CA
  13:[37.8833,-120.0500],14:[37.1158,-119.2908],15:[39.2613,-121.0155],
  16:[39.6888,-123.4833],17:[38.4405,-122.7144],18:[37.0516,-122.0183],
  19:[37.0416,-122.0283],20:[38.5546,-123.0775],21:[37.4275,-122.1697],
  22:[39.3208,-123.4033],
  // National math camps
  23:[34.1037,-117.7120], // Mathcamp (Harvey Mudd ‚Äî location varies)
  24:[39.9986,-83.0154],  // Ross ‚Äî Ohio State
  25:[42.3505,-71.1054],  // PROMYS ‚Äî Boston University
  26:[37.4252,-122.1680], // SUMaC ‚Äî Stanford
  27:[32.8801,-117.2340], // AwesomeMath ‚Äî UC San Diego
  28:[38.9356,-77.0878],  // MathPath (American Univ ‚Äî location varies)
  29:[42.3242,-72.5218],  // HCSSiM ‚Äî Hampshire College
  30:[40.0194,-75.3152],  // MathILy ‚Äî Bryn Mawr
};
// Camps whose location rotates yearly
const VARIES_LOCATION = new Set([23, 28]);

let _map = null;
let _mapMarkers = [];

function setMapView(toMap) {
  S.mapView = toMap;
  document.getElementById('viewListBtn').classList.toggle('active', !toMap);
  document.getElementById('viewMapBtn').classList.toggle('active', toMap);
  renderAll();
}

function renderMap(filtered) {
  const el = document.getElementById('campMap');
  if(!_map) {
    _map = L.map('campMap').setView([37.7749, -122.4194], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(_map);
  }
  _mapMarkers.forEach(m => m.remove());
  _mapMarkers = [];

  const pts = [];
  const missing = [];
  const fri = S.selWeek ? iso(addD(pd(S.selWeek),4)) : null;

  const shownCamps = new Set();
  filtered.forEach(camp => {
    const locs = camp.locations?.length ? camp.locations : [null];
    locs.forEach(loc => {
      const c = camp.custom ? null : COORDS[camp.id];
      if(!c) {
        if(!shownCamps.has(camp.id)) { if(camp.custom) missing.push(camp.name); shownCamps.add(camp.id); }
        return;
      }

      const marker = L.circleMarker(c, {
        radius: 9, fillColor: camp.color, color: '#fff',
        weight: 2, opacity: 1, fillOpacity: .88
      });

      const avail = S.selWeek ? campAvail(camp, S.selWeek, fri) : true;
      const sf = S.selWeek && camp.sleep ? getSessForWeek(camp, S.selWeek, fri) : null;
      const variesNote = VARIES_LOCATION.has(camp.id)
        ? `<div style="font-size:.68rem;color:#f59e0b;margin-bottom:5px">‚ö† Location varies by year ‚Äî pin is approximate</div>` : '';
      const actionBtn = S.selWeek
        ? (avail
            ? `<button onclick="addToPlan(${camp.id},${sf?.sess?.id??null})" style="margin-top:7px;width:100%;padding:.3rem .65rem;background:var(--primary);color:white;border:none;border-radius:6px;font-size:.75rem;font-weight:700;cursor:pointer">+ Consider for ${S.kids[S.activeKid].name}</button>`
            : `<div style="margin-top:6px;font-size:.72rem;color:#94a3b8">Not available this week</div>`)
        : `<div style="display:flex;gap:.5rem;margin-top:7px">
            ${(loc?.url||camp.url) ? `<a href="${loc?.url||camp.url}" target="_blank" style="font-size:.75rem;font-weight:700;color:var(--primary);text-decoration:none">Camp Info ‚Üí</a>` : ''}
           </div>`;

      const displayName = loc?.name ? `${camp.name} ‚Äî ${loc.name}` : camp.name;
      const displayLoc = loc?.loc || camp.loc || '';
      marker.bindPopup(`<div style="min-width:185px">
        <div style="height:3px;background:${camp.color};margin:-2px -12px 8px;border-radius:2px 2px 0 0"></div>
        <div style="font-size:.84rem;font-weight:700;line-height:1.3;margin-bottom:3px">${displayName}</div>
        <div style="font-size:.71rem;color:#64748b;margin-bottom:2px">${camp.sleep?'Sleepaway':'Day'} ¬∑ ${(camp.tags||[camp.type]).join(', ')}</div>
        <div style="font-size:.71rem;color:#64748b;margin-bottom:5px">Ages ${camp.ageMin}‚Äì${camp.ageMax} ¬∑ ${camp.cost}</div>
        ${displayLoc ? `<div style="font-size:.68rem;color:#94a3b8;margin-bottom:4px">${displayLoc}</div>` : ''}
        ${variesNote}${actionBtn}
      </div>`, { maxWidth: 240 });

      marker.addTo(_map);
      _mapMarkers.push(marker);
      pts.push(c);
    });
  });

  if(pts.length === 1) _map.setView(pts[0], 13);
  else if(pts.length > 1) _map.fitBounds(pts, { padding: [50, 50] });

  setTimeout(() => _map.invalidateSize(), 80);

  // Note about unmapped custom camps
  let note = document.getElementById('mapNote');
  if(!note) {
    note = document.createElement('div');
    note.id = 'mapNote';
    note.style.cssText = 'position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(255,255,255,.93);border:1px solid var(--border);border-radius:8px;padding:.35rem .85rem;font-size:.72rem;color:var(--muted);pointer-events:none;white-space:nowrap';
    el.style.position = 'relative';
    el.appendChild(note);
  }
  note.style.display = missing.length ? 'block' : 'none';
  if(missing.length) note.textContent = `${missing.length} custom camp${missing.length>1?'s':''} not shown on map (no coordinates)`;
}

// ‚îÄ‚îÄ A/B admin panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleTitleClick() {
  _adminClicks++;
  if(_adminClicks >= 5) { _adminClicks = 0; showAdmin(); return; }
  clearTimeout(handleTitleClick._t);
  handleTitleClick._t = setTimeout(() => { _adminClicks = 0; }, 2000);
}
async function showAdmin() {
  document.getElementById('adminPanel').style.display = 'flex';
  const el = document.getElementById('adminContent');
  el.innerHTML = '<p style="color:var(--muted)">Loading‚Ä¶</p>';
  const { data, error } = await sb.rpc('get_ab_results');
  if(error) { el.innerHTML = `<p style="color:var(--red)">${error.message}</p>`; return; }
  if(!data?.length) { el.innerHTML = '<p>No data yet.</p>'; return; }
  const rows = data.map(r => `<tr>
    <td style="padding:.5rem .75rem;font-weight:700">Variant ${r.variant}</td>
    <td style="padding:.5rem .75rem;text-align:right">${r.users}</td>
    <td style="padding:.5rem .75rem;text-align:right">${r.converted} (${r.users>0?Math.round(r.converted/r.users*100):0}%)</td>
    <td style="padding:.5rem .75rem;text-align:right">${r.avg_minutes!=null?r.avg_minutes+' min':'‚Äî'}</td>
  </tr>`).join('');
  el.innerHTML = `<p style="font-size:.78rem;color:var(--muted);margin-bottom:.75rem;line-height:1.6">
    <strong>A</strong> = current layout &nbsp;¬∑&nbsp; <strong>B</strong> = kid names above columns<br>
    "Converted" = added ‚â•1 planned camp &nbsp;¬∑&nbsp; Your variant: <strong>${S.variant||'‚Äî'}</strong>
  </p>
  <table style="width:100%;border-collapse:collapse;font-size:.85rem;border:1px solid var(--border);border-radius:8px;overflow:hidden">
    <thead><tr style="background:#f4f8fb">
      <th style="padding:.5rem .75rem;text-align:left;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em">Variant</th>
      <th style="padding:.5rem .75rem;text-align:right;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em">Users</th>
      <th style="padding:.5rem .75rem;text-align:right;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em">Converted</th>
      <th style="padding:.5rem .75rem;text-align:right;font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.04em">Avg time to plan</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}
function closeAdmin() {
  document.getElementById('adminPanel').style.display = 'none';
}

function openProfile() {
  document.getElementById('profileHome').value = S.profile.homeAddress || '';
  document.getElementById('profileWork').value = S.profile.workAddress || '';
  document.getElementById('profileModal').style.display = 'flex';
}
function closeProfile() {
  document.getElementById('profileModal').style.display = 'none';
}
function saveProfile() {
  S.profile.homeAddress = document.getElementById('profileHome').value.trim();
  S.profile.workAddress = document.getElementById('profileWork').value.trim();
  closeProfile();
  scheduleSave();
}

function renderAll() {
  WEEKS = genAllWeeks();
  renderSummary(); renderWeeks(); renderCamps();
  scheduleSave();
}

function selWeek(mon) { S.selWeek=S.selWeek===mon?null:mon; S.focusedCamp=null; renderAll(); }
function selWeekKid(mon, kidIdx) {
  if(S.selWeek===mon && S.activeKid===kidIdx) { S.selWeek=null; }
  else { S.selWeek=mon; S.activeKid=kidIdx; }
  S.focusedCamp=null;
  renderAll();
}
function setActiveKid(kidIdx) { S.activeKid=kidIdx; S.focusedCamp=null; renderAll(); }
function toggleCard(id) { S.focusedCamp=null; S.expandCard=S.expandCard===id?null:id; renderCamps(); }

function showCampCard(campId) {
  S.focusedCamp = campId;
  renderCamps();
}

function clearFocusedCamp() {
  S.focusedCamp = null;
  S.expandCard = null;
  renderCamps();
}

// ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tgl[data-sl]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tgl[data-sl]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); S.slFilter=b.dataset.sl; renderAll();
}));
document.querySelectorAll('.tgl[data-app]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tgl[data-app]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); S.appFilter=b.dataset.app; renderAll();
}));
document.querySelectorAll('.tgl[data-virt]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tgl[data-virt]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); S.virtFilter=b.dataset.virt; renderAll();
}));
document.getElementById('actFilter').addEventListener('change', e=>{ S.actFilter=e.target.value; renderAll(); });
document.getElementById('campSearch').addEventListener('input', e=>{ S.q=e.target.value; renderAll(); });
document.getElementById('distFilter').addEventListener('change', e=>{ S.distFilter=e.target.value; renderCamps(); });
document.getElementById('zipInput').addEventListener('input', e=>{
  S.zipFilter=e.target.value;
  if(e.target.value.length===5) geocodeZip(e.target.value);
  else { S._userLat=null; S._userLng=null; renderCamps(); }
});

renderKidRows();
updatePanelWidth();

// ‚îÄ‚îÄ Supabase auth & persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const { createClient } = supabase;
const sb = createClient(
  'https://qdtgylkhksqwecocbklq.supabase.co',
  'sb_publishable_gUGUwEktFMs5z4vjay-8xQ_5rU_gPZW'
);

let currentUser = null;
let _loading = false;
let _saveTimer = null;
let _authMode = 'signin';
let _planCreatedAt = null;
let _firstPlanAt = null;
let _adminClicks = 0;
let _campsLoaded = false;
let _isAdmin = false;

loadCamps(); // public table ‚Äî no auth required

async function loadCamps() {
  const { data } = await sb.from('camps')
    .select('*, locations(*, sessions(*))')
    .eq('active', true).order('name');
  if (data) {
    CAMPS = data.map(row => {
      const locations = (row.locations || []).map(loc => ({
        id:      loc.id,
        campId:  loc.camp_id,
        name:    loc.name || null,
        street:  loc.street_address || null,
        city:    loc.city || null,
        state:   loc.state || null,
        zip:     loc.zip || null,
        country: loc.country || null,
        url:     loc.url || null,
        lat:     loc.lat ?? null,
        lng:     loc.lng ?? null,
        get loc() {
          return [this.street, this.city, [this.state, this.zip].filter(Boolean).join(' ')]
                   .filter(Boolean).join(', ') || '';
        },
        sessions: (loc.sessions || [])
          .sort((a, b) => a.start_date < b.start_date ? -1 : 1)
          .map(s => ({
            id:          s.id,
            locationId:  loc.id,
            locationName: loc.name || null,
            s: s.start_date, e: s.end_date, lbl: s.label,
            cost:        s.cost || null, costN: s.cost_n || 0,
            startTime:   s.start_time || null, endTime: s.end_time || null,
            appDeadline: s.app_deadline || null,
            ageMin:      s.age_min ?? null, ageMax: s.age_max ?? null,
            virtual:     s.virtual || false,
          })),
      }));
      return {
        id:           row.id,
        name:         row.name,
        type:         row.type,
        tags:         (row.type || '').split(',').map(t => t.trim()).filter(Boolean),
        sleep:        row.sleep,
        verified:     row.review_status === 'verified',
        reviewStatus: row.review_status,
        scrapedAt:    row.scraped_at,
        verifiedAt:   row.verified_at,
        taxId:        row.tax_id,
        appRequired:  row.app_required,
        desc:         row.description,
        ageMin:       row.age_min,
        ageMax:       row.age_max,
        apply:        row.apply_info,
        appDeadline:  row.app_deadline || null,
        virtual:      row.virtual || false,
        locations,
        // Backward-compat getters (single-location camps)
        get loc()    { return this.locations[0]?.loc || ''; },
        get city()   { return this.locations[0]?.city || null; },
        get state()  { return this.locations[0]?.state || null; },
        get street() { return this.locations[0]?.street || null; },
        // Flat sessions across all locations
        get sessions() { return this.locations.flatMap(l => l.sessions); },
        // Derive camp-level cost summary from sessions for display and budget fallback
        get cost() {
          const nums = this.sessions.map(s => s.costN).filter(n => n > 0);
          if (nums.length) {
            const mn = Math.min(...nums), mx = Math.max(...nums);
            const sfx = this.sleep ? '/session' : '/wk';
            return mn === mx ? `~$${mn.toLocaleString()}${sfx}` : `~$${mn.toLocaleString()}‚Äì$${mx.toLocaleString()}${sfx}`;
          }
          return this.sessions.find(s => s.cost && s.cost !== 'See website')?.cost || 'See website';
        },
        get costN() {
          const nums = this.sessions.map(s => s.costN).filter(n => n > 0);
          return nums.length ? Math.min(...nums) : 0;
        },
        url:          row.url,
        websiteUrl:   row.website_url || null,
        color:        row.color,
        range:        row.date_range || null,
        comingSoon:   row.coming_soon || false,
      };
    });
  }
  _campsLoaded = true;
  populateActFilter();
  renderAll();
}

sb.auth.onAuthStateChange((event, session) => {
  currentUser = session?.user ?? null;
  if(currentUser) {
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('userBar').style.display = 'flex';
    document.getElementById('userEmail').textContent = currentUser.email;
    loadPlan();
  } else {
    document.getElementById('authModal').style.display = 'flex';
    document.getElementById('userBar').style.display = 'none';
  }
});

function switchTab(mode) {
  _authMode = mode;
  document.getElementById('tabSignin').classList.toggle('active', mode==='signin');
  document.getElementById('tabSignup').classList.toggle('active', mode==='signup');
  document.getElementById('authSubmit').textContent = mode==='signin' ? 'Sign in' : 'Create account';
  document.getElementById('authPassword').autocomplete = mode==='signin' ? 'current-password' : 'new-password';
  setAuthMsg('');
}

function setAuthMsg(msg, type='error') {
  const el = document.getElementById('authMsg');
  el.textContent = msg;
  el.className = `auth-msg ${type}`;
}

async function handleAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const btn = document.getElementById('authSubmit');
  if(!email || !password) { setAuthMsg('Enter your email and password.'); return; }
  btn.disabled = true;
  setAuthMsg('');
  if(_authMode === 'signin') {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) { setAuthMsg(error.message); btn.disabled = false; }
  } else {
    const { error } = await sb.auth.signUp({ email, password });
    if(error) { setAuthMsg(error.message); btn.disabled = false; }
    else { setAuthMsg('Check your email to confirm your account, then sign in.', 'info'); btn.disabled = false; }
  }
}

async function signOut() {
  await sb.auth.signOut();
}

async function signInWithGoogle() {
  const btn = document.getElementById('googleSignInBtn');
  if (btn) btn.disabled = true;
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: location.origin + location.pathname }
  });
  if (error) {
    setAuthMsg(error.message);
    if (btn) btn.disabled = false;
  }
}

function _applyPlanData(planData) {
  if(planData?.customCamps) S.customCamps = planData.customCamps;
  if(planData?.vacation) S.vacation = planData.vacation;
  if(planData?.profile) S.profile = { homeAddress:'', workAddress:'', ...planData.profile };
  if(planData?.kids) {
    S.kids = planData.kids;
    if(S.activeKid >= S.kids.length) S.activeKid = S.kids.length-1;
    document.querySelectorAll('#kidCountToggle .tgl').forEach((btn,i) =>
      btn.classList.toggle('active', i+1===S.kids.length));
    renderKidRows();
    updatePanelWidth();
  }
}

async function loadPlan() {
  _loading = true;
  S.household = null;
  S.group = null;

  // Check household membership
  const { data: hm } = await sb.from('household_members')
    .select('household_id, households(id, owner_id)')
    .eq('user_id', currentUser.id).maybeSingle();

  if(hm) {
    S.household = {
      id: hm.household_id,
      ownerId: hm.households.owner_id,
      isOwner: hm.households.owner_id === currentUser.id
    };
    const { data: hp } = await sb.from('household_plans')
      .select('plan_data').eq('household_id', hm.household_id).maybeSingle();
    if(hp?.plan_data) _applyPlanData(hp.plan_data);
    S.variant = S.variant || (Math.random() < 0.5 ? 'A' : 'B');
    if(!_planCreatedAt) _planCreatedAt = new Date().toISOString();
  } else {
    // Solo plan load
    const { data } = await sb.from('plans')
      .select('plan_data, variant, plan_created_at, first_plan_at')
      .eq('user_id', currentUser.id)
      .maybeSingle();
    if(data) {
      S.variant = data.variant || (Math.random() < 0.5 ? 'A' : 'B');
      _planCreatedAt = data.plan_created_at;
      _firstPlanAt = data.first_plan_at;
      _applyPlanData(data.plan_data);
    } else {
      S.variant = Math.random() < 0.5 ? 'A' : 'B';
      _planCreatedAt = new Date().toISOString();
      _firstPlanAt = null;
    }
  }

  // Check group membership
  const { data: gm } = await sb.from('group_members')
    .select('group_id, display_name, camp_groups(id, name, invite_code)')
    .eq('user_id', currentUser.id).maybeSingle();
  if(gm) {
    S.group = {
      id: gm.group_id,
      name: gm.camp_groups.name,
      inviteCode: gm.camp_groups.invite_code,
      members: []
    };
    loadGroupPlans(); // async, will re-render when done
  }

  // Process pending invite if any
  if(_pendingInvite) {
    const token = _pendingInvite;
    _pendingInvite = null;
    processPendingInvite(token);
  }

  const { data: adminRow } = await sb.from('admins')
    .select('user_id').eq('user_id', currentUser.id).maybeSingle();
  _isAdmin = !!adminRow;

  renderAll();
  renderCollabArea();
  _loading = false;
}

function scheduleSave() {
  if(!currentUser || _loading) return;
  clearTimeout(_saveTimer);
  setSaveDot('Saving‚Ä¶');
  _saveTimer = setTimeout(savePlan, 1200);
}

async function savePlan() {
  if(!currentUser) return;
  if(!_planCreatedAt) _planCreatedAt = new Date().toISOString();
  const planData = { kids: S.kids, customCamps: S.customCamps, vacation: S.vacation, profile: S.profile };

  if(S.household) {
    const { error } = await sb.from('household_plans').upsert({
      household_id: S.household.id,
      plan_data: planData,
      updated_at: new Date().toISOString()
    }, { onConflict: 'household_id' });
    if(error) { setSaveDot('Save failed ‚úï'); return; }
  } else {
    const hasAnyPlanned = S.kids.some(k => Object.keys(k.planned).length > 0);
    if(hasAnyPlanned && !_firstPlanAt) _firstPlanAt = new Date().toISOString();
    const { error } = await sb.from('plans').upsert({
      user_id: currentUser.id,
      plan_data: planData,
      variant: S.variant,
      plan_created_at: _planCreatedAt,
      first_plan_at: _firstPlanAt,
      updated_at: new Date().toISOString()
    });
    if(error) { setSaveDot('Save failed ‚úï'); return; }
  }

  setSaveDot('Saved ‚úì');
  setTimeout(() => setSaveDot(''), 2000);
}

function setSaveDot(msg) {
  const el = document.getElementById('saveDot');
  if(el) el.textContent = msg;
}

// ‚îÄ‚îÄ Collab area rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _collabMenuOpen = false;
function renderCollabArea() {
  const el = document.getElementById('collabArea');
  if(!el) return;
  const adminBtn = _isAdmin
    ? `<button class="collab-pill" style="background:rgba(255,255,255,.18);margin-right:.35rem" onclick="openAdminCampsModal()">‚öô Camps</button>`
    : '';
  if(S.household) {
    el.innerHTML = adminBtn + `<button class="collab-pill" onclick="openHouseholdManage()"><span class="dot"></span> Shared plan</button>`;
  } else if(S.group) {
    el.innerHTML = adminBtn + `<button class="collab-pill" onclick="openGroupManage()">üë• ${S.group.name}</button>`;
  } else {
    el.innerHTML = adminBtn + `<div style="position:relative">
      <button class="collab-pill" id="collabMenuBtn" onclick="toggleCollabMenu()">üë• Share ‚ñæ</button>
      <div class="collab-menu" id="collabMenu" style="display:none">
        <button onclick="closeCollabMenu();invitePartner()">Invite partner (shared plan)</button>
        <div class="cm-divider"></div>
        <button onclick="closeCollabMenu();openGroupCreate()">Create friend group</button>
        <button onclick="closeCollabMenu();openGroupJoin()">Join friend group</button>
      </div>
    </div>`;
  }
}
function toggleCollabMenu() {
  const m = document.getElementById('collabMenu');
  if(!m) return;
  const open = m.style.display !== 'none';
  m.style.display = open ? 'none' : 'block';
  if(!open) {
    setTimeout(() => document.addEventListener('click', _closeCollabOnOutside, {once:true}), 0);
  }
}
function _closeCollabOnOutside(e) {
  const m = document.getElementById('collabMenu');
  const btn = document.getElementById('collabMenuBtn');
  if(m && !m.contains(e.target) && e.target !== btn) m.style.display = 'none';
}
function closeCollabMenu() {
  const m = document.getElementById('collabMenu'); if(m) m.style.display='none';
}

// ‚îÄ‚îÄ Household: invite partner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function invitePartner() {
  if(!currentUser) return;
  document.getElementById('hhModalTitle').textContent = 'Invite Partner';
  const content = document.getElementById('hhModalContent');
  content.innerHTML = `<p style="font-size:.85rem;color:var(--muted);margin-bottom:1rem">Creating your shared household plan‚Ä¶</p>`;
  document.getElementById('householdModal').style.display = 'flex';

  // Create household
  const { data: hh, error: hhErr } = await sb.from('households')
    .insert({ owner_id: currentUser.id }).select('id').single();
  if(hhErr) { content.innerHTML=`<p style="color:var(--red);font-size:.85rem">Error: ${hhErr.message}</p>`; return; }

  // Add self to household_members
  await sb.from('household_members').insert({ household_id: hh.id, user_id: currentUser.id });

  // Migrate current solo plan to household_plans
  const planData = { kids: S.kids, customCamps: S.customCamps, vacation: S.vacation, profile: S.profile };
  await sb.from('household_plans').insert({ household_id: hh.id, plan_data: planData });

  // Update local state
  S.household = { id: hh.id, ownerId: currentUser.id, isOwner: true };
  renderCollabArea();

  // Create invite token
  const { data: inv, error: invErr } = await sb.from('household_invites')
    .insert({ household_id: hh.id }).select('token').single();
  if(invErr) { content.innerHTML=`<p style="color:var(--red);font-size:.85rem">Household created but invite failed: ${invErr.message}</p>`; return; }

  const link = `${location.origin}${location.pathname}?invite=${inv.token}`;
  content.innerHTML = `
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:.75rem">Share this link with your partner. When they open it and log in, they'll join your shared plan.</p>
    <div class="invite-link-box">
      <input type="text" id="inviteLinkInput" value="${link}" readonly onclick="this.select()" />
      <button class="btn btn-solid" style="flex-shrink:0;white-space:nowrap" onclick="copyInviteLink()">Copy</button>
    </div>
    <p id="copyMsg" style="font-size:.75rem;color:var(--green);min-height:1.1em;margin-top:.2rem"></p>
    <p style="font-size:.75rem;color:var(--muted);margin-top:.5rem">Both of you will read and write from the same plan (last save wins).</p>
    <div style="display:flex;justify-content:flex-end;margin-top:1.25rem">
      <button class="btn btn-outline" onclick="closeHouseholdModal()">Done</button>
    </div>`;
}

function copyInviteLink() {
  const inp = document.getElementById('inviteLinkInput');
  if(!inp) return;
  inp.select();
  navigator.clipboard.writeText(inp.value).then(() => {
    const msg = document.getElementById('copyMsg');
    if(msg) { msg.textContent = '‚úì Link copied!'; setTimeout(()=>msg.textContent='',2500); }
  });
}

// ‚îÄ‚îÄ Household: process pending invite ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function processPendingInvite(token) {
  if(!currentUser || !token) return;
  // Fetch invite
  const { data: inv } = await sb.from('household_invites')
    .select('id, household_id, accepted_at, households(id, owner_id)')
    .eq('token', token).maybeSingle();
  if(!inv) { showInviteError('This invite link is invalid or has expired.'); return; }
  if(inv.accepted_at) { showInviteError('This invite link has already been used.'); return; }
  if(inv.household_id === S.household?.id) { showInviteError('You are already in this shared plan.'); return; }

  // Show join confirmation
  document.getElementById('hhModalTitle').textContent = 'Join Shared Plan';
  const content = document.getElementById('hhModalContent');
  content.innerHTML = `
    <p style="font-size:.88rem;margin-bottom:1.25rem">You've been invited to join a shared summer camp plan.<br><br>
    <strong>Your current plan will be replaced by the shared plan.</strong> Are you sure?</p>
    <div style="display:flex;justify-content:flex-end;gap:.75rem">
      <button class="btn btn-outline" onclick="closeHouseholdModal()">Cancel</button>
      <button class="btn btn-solid" onclick="acceptHouseholdInvite('${inv.id}','${inv.household_id}')">Join shared plan</button>
    </div>`;
  document.getElementById('householdModal').style.display = 'flex';
  // Clean URL
  history.replaceState(null,'',location.pathname);
}

function showInviteError(msg) {
  document.getElementById('hhModalTitle').textContent = 'Invalid Invite';
  document.getElementById('hhModalContent').innerHTML =
    `<p style="font-size:.85rem;color:var(--red);margin-bottom:1rem">${msg}</p>
     <div style="display:flex;justify-content:flex-end"><button class="btn btn-outline" onclick="closeHouseholdModal()">Close</button></div>`;
  document.getElementById('householdModal').style.display = 'flex';
}

async function acceptHouseholdInvite(inviteId, householdId) {
  const content = document.getElementById('hhModalContent');
  content.innerHTML = `<p style="font-size:.85rem;color:var(--muted)">Joining‚Ä¶</p>`;

  // Join household
  const { error: joinErr } = await sb.from('household_members')
    .insert({ household_id: householdId, user_id: currentUser.id });
  if(joinErr && !joinErr.message.includes('duplicate')) {
    content.innerHTML=`<p style="color:var(--red);font-size:.85rem">Error joining: ${joinErr.message}</p>`; return;
  }

  // Mark invite accepted
  await sb.from('household_invites').update({ accepted_at: new Date().toISOString() }).eq('id', inviteId);

  // Fetch household info & shared plan
  const { data: hh } = await sb.from('households').select('id, owner_id').eq('id', householdId).single();
  S.household = { id: householdId, ownerId: hh.owner_id, isOwner: hh.owner_id === currentUser.id };
  const { data: hp } = await sb.from('household_plans').select('plan_data').eq('household_id', householdId).maybeSingle();
  if(hp?.plan_data) _applyPlanData(hp.plan_data);

  renderAll();
  renderCollabArea();
  closeHouseholdModal();
}

// ‚îÄ‚îÄ Household: manage modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openHouseholdManage() {
  document.getElementById('hhModalTitle').textContent = 'Shared Plan';
  const content = document.getElementById('hhModalContent');
  content.innerHTML = `<p style="font-size:.85rem;color:var(--muted)">Loading‚Ä¶</p>`;
  document.getElementById('householdModal').style.display = 'flex';

  const { data: members } = await sb.from('household_members')
    .select('user_id').eq('household_id', S.household.id);

  // Get emails via plans table (best effort)
  const uids = (members||[]).map(m=>m.user_id);
  const partnerUid = uids.find(uid => uid !== currentUser.id);

  content.innerHTML = `
    <div style="margin-bottom:1rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem">Members</div>
      <ul class="member-list">
        <li><span class="member-dot"></span> You (${currentUser.email})</li>
        ${partnerUid ? `<li><span class="member-dot"></span> Partner</li>` : `<li style="color:var(--muted);font-style:italic">No partner joined yet</li>`}
      </ul>
    </div>
    ${S.household.isOwner ? `
    <div style="margin-bottom:1rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem">Invite link</div>
      <button class="btn btn-outline" style="font-size:.8rem" onclick="regenerateInviteLink()">Generate new invite link</button>
      <div id="newInviteLinkArea"></div>
    </div>` : ''}
    <div style="border-top:1px solid var(--border);padding-top:1rem;margin-top:.5rem;display:flex;justify-content:space-between;align-items:center">
      <button class="btn btn-outline" style="border-color:var(--red);color:var(--red);font-size:.8rem" onclick="leaveHousehold()">Disconnect from shared plan</button>
      <button class="btn btn-outline" onclick="closeHouseholdModal()">Close</button>
    </div>`;
}

async function regenerateInviteLink() {
  const area = document.getElementById('newInviteLinkArea');
  if(!area) return;
  area.innerHTML = `<p style="font-size:.8rem;color:var(--muted);margin-top:.4rem">Generating‚Ä¶</p>`;
  const { data: inv, error } = await sb.from('household_invites')
    .insert({ household_id: S.household.id }).select('token').single();
  if(error) { area.innerHTML=`<p style="color:var(--red);font-size:.8rem">${error.message}</p>`; return; }
  const link = `${location.origin}${location.pathname}?invite=${inv.token}`;
  area.innerHTML = `<div class="invite-link-box" style="margin-top:.5rem">
    <input type="text" id="newInviteInput" value="${link}" readonly onclick="this.select()" style="flex:1;border:none;background:transparent;font-size:.75rem;color:var(--text);outline:none;font-family:monospace;min-width:0" />
    <button class="btn btn-solid" style="flex-shrink:0;font-size:.75rem;padding:.3rem .6rem" onclick="navigator.clipboard.writeText(document.getElementById('newInviteInput').value)">Copy</button>
  </div>`;
}

async function leaveHousehold() {
  if(!confirm('Are you sure you want to disconnect from the shared plan? Your plan data will remain but you\'ll be on an independent copy.')) return;
  await sb.from('household_members').delete().eq('household_id', S.household.id).eq('user_id', currentUser.id);
  if(S.household.isOwner) {
    await sb.from('households').delete().eq('id', S.household.id);
  }
  S.household = null;
  closeHouseholdModal();
  renderCollabArea();
  // Save current state as solo plan
  scheduleSave();
}

function closeHouseholdModal() {
  document.getElementById('householdModal').style.display = 'none';
}

// ‚îÄ‚îÄ Friend group: create ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGroupCreate() {
  document.getElementById('grpModalTitle').textContent = 'Create Friend Group';
  document.getElementById('grpModalContent').innerHTML = `
    <div class="modal-field">
      <label>Group name</label>
      <input type="text" id="grpNameInput" placeholder="e.g. SF Moms 2026" autocomplete="off" />
    </div>
    <div class="modal-field">
      <label>Your display name in the group</label>
      <input type="text" id="grpDisplayInput" placeholder="e.g. Sarah" autocomplete="off" />
    </div>
    <div id="grpCreateMsg" style="font-size:.8rem;color:var(--red);min-height:1.2em;margin-bottom:.5rem"></div>
    <div style="display:flex;justify-content:flex-end;gap:.75rem">
      <button class="btn btn-outline" onclick="closeGroupModal()">Cancel</button>
      <button class="btn btn-solid" onclick="createGroup()">Create group</button>
    </div>`;
  document.getElementById('groupModal').style.display = 'flex';
}

async function createGroup() {
  const name = document.getElementById('grpNameInput')?.value.trim();
  const displayName = document.getElementById('grpDisplayInput')?.value.trim();
  const msg = document.getElementById('grpCreateMsg');
  if(!name) { if(msg) msg.textContent='Enter a group name.'; return; }
  if(!displayName) { if(msg) msg.textContent='Enter your display name.'; return; }
  if(msg) msg.textContent='';

  const { data: grp, error: grpErr } = await sb.from('camp_groups')
    .insert({ name, created_by: currentUser.id }).select('id, name, invite_code').single();
  if(grpErr) { if(msg) msg.textContent=grpErr.message; return; }

  const { error: memErr } = await sb.from('group_members')
    .insert({ group_id: grp.id, user_id: currentUser.id, display_name: displayName });
  if(memErr) { if(msg) msg.textContent=memErr.message; return; }

  S.group = { id: grp.id, name: grp.name, inviteCode: grp.invite_code, members: [] };
  renderCollabArea();

  document.getElementById('grpModalTitle').textContent = grp.name;
  document.getElementById('grpModalContent').innerHTML = `
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:.75rem">Share this code with friends so they can join your group:</p>
    <div class="invite-code-box">${grp.invite_code}</div>
    <p style="font-size:.78rem;color:var(--muted);margin:.4rem 0 1.25rem">Friends enter this code under Share ‚Üí Join friend group.</p>
    <div style="display:flex;justify-content:flex-end">
      <button class="btn btn-solid" onclick="closeGroupModal()">Done</button>
    </div>`;
}

// ‚îÄ‚îÄ Friend group: join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGroupJoin() {
  document.getElementById('grpModalTitle').textContent = 'Join Friend Group';
  document.getElementById('grpModalContent').innerHTML = `
    <div class="modal-field">
      <label>Invite code</label>
      <input type="text" id="grpCodeInput" placeholder="8-character code" autocomplete="off" maxlength="8" style="font-family:monospace;font-size:1rem;letter-spacing:.1em;text-transform:uppercase" />
    </div>
    <div class="modal-field">
      <label>Your display name in the group</label>
      <input type="text" id="grpJoinDisplayInput" placeholder="e.g. Emma" autocomplete="off" />
    </div>
    <div id="grpJoinMsg" style="font-size:.8rem;color:var(--red);min-height:1.2em;margin-bottom:.5rem"></div>
    <div style="display:flex;justify-content:flex-end;gap:.75rem">
      <button class="btn btn-outline" onclick="closeGroupModal()">Cancel</button>
      <button class="btn btn-solid" onclick="joinGroup()">Join group</button>
    </div>`;
  document.getElementById('groupModal').style.display = 'flex';
}

async function joinGroup() {
  const code = document.getElementById('grpCodeInput')?.value.trim().toLowerCase();
  const displayName = document.getElementById('grpJoinDisplayInput')?.value.trim();
  const msg = document.getElementById('grpJoinMsg');
  if(!code) { if(msg) msg.textContent='Enter the invite code.'; return; }
  if(!displayName) { if(msg) msg.textContent='Enter your display name.'; return; }
  if(msg) msg.textContent='';

  const { data: grp } = await sb.from('camp_groups')
    .select('id, name, invite_code').eq('invite_code', code).maybeSingle();
  if(!grp) { if(msg) msg.textContent='No group found with that code.'; return; }

  const { error: memErr } = await sb.from('group_members')
    .insert({ group_id: grp.id, user_id: currentUser.id, display_name: displayName });
  if(memErr) { if(msg) msg.textContent=memErr.message; return; }

  S.group = { id: grp.id, name: grp.name, inviteCode: grp.invite_code, members: [] };
  renderCollabArea();
  loadGroupPlans();
  closeGroupModal();
}

// ‚îÄ‚îÄ Friend group: manage modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGroupManage() {
  if(!S.group) return;
  document.getElementById('grpModalTitle').textContent = S.group.name;
  const memberRows = S.group.members.map(m =>
    `<li><span class="member-dot"></span> ${m.displayName}</li>`
  ).join('');
  document.getElementById('grpModalContent').innerHTML = `
    <div style="margin-bottom:1rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem">Invite code</div>
      <div class="invite-code-box">${S.group.inviteCode}</div>
      <p style="font-size:.75rem;color:var(--muted);margin-top:.2rem">Share this with friends to join.</p>
    </div>
    ${S.group.members.length ? `
    <div style="margin-bottom:1rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.4rem">Members</div>
      <ul class="member-list">${memberRows}</ul>
    </div>` : ''}
    <div style="border-top:1px solid var(--border);padding-top:1rem;display:flex;justify-content:space-between;align-items:center">
      <button class="btn btn-outline" style="border-color:var(--red);color:var(--red);font-size:.8rem" onclick="leaveGroup()">Leave group</button>
      <button class="btn btn-outline" onclick="closeGroupModal()">Close</button>
    </div>`;
  document.getElementById('groupModal').style.display = 'flex';
}

async function leaveGroup() {
  if(!S.group) return;
  if(!confirm('Leave this friend group? You can rejoin with the same code.')) return;
  await sb.from('group_members').delete().eq('group_id', S.group.id).eq('user_id', currentUser.id);
  S.group = null;
  closeGroupModal();
  renderCollabArea();
  renderAll();
}

function closeGroupModal() {
  document.getElementById('groupModal').style.display = 'none';
}

// ‚îÄ‚îÄ Load group plans ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadGroupPlans() {
  if(!S.group) return;
  const { data, error } = await sb.rpc('get_group_plans', { p_group_id: S.group.id });
  if(error || !data) return;
  S.group.members = data
    .filter(row => row.uid !== currentUser.id)
    .map(row => ({ userId: row.uid, displayName: row.display_name, planData: row.plan_data }));
  renderAll(); // re-render with friend indicators
}

renderAll();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Recommendation Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const WIZ = {
  step:0, numSteps:6,
  kidCount:2,
  kidData:[],        // [{name,age,lastDay,firstDay,prefs:[],_interestText:'',_detected:null}]
  style:'both',      // 'day'|'sleep'|'both'
  totalBudget:null,  // null=no limit, number=total summer $ cap
  locationPref:'',   // ''|'home'|'work'
  mode:'together',   // 'together'|'separate'
  vacationWeeks:new Set(), // ISO mon strings to skip
  _recs:[],          // [{mon,weekLabel,campName,type,isSleep,kidLabel}]
};

// maps: which DB camp types this interest matches
const WIZ_ACT = [
  // Sports & Athletics
  {type:'Soccer',         icon:'‚öΩ', label:'Soccer',                maps:['Sports']},
  {type:'Basketball',     icon:'üèÄ', label:'Basketball',            maps:['Sports']},
  {type:'Tennis',         icon:'üéæ', label:'Tennis',                maps:['Sports']},
  {type:'Swimming',       icon:'üèä', label:'Swimming',              maps:['Sports','Nature']},
  {type:'Fencing',        icon:'ü§∫', label:'Fencing',               maps:['Sports']},
  {type:'Martial Arts',   icon:'ü•ã', label:'Martial Arts',          maps:['Sports']},
  {type:'Sports',         icon:'üèÖ', label:'Sports (General)',      maps:['Sports']},
  // Arts & Creativity
  {type:'Arts',           icon:'üé®', label:'Visual Arts & Crafts',  maps:['Arts']},
  {type:'Performing Arts',icon:'üé≠', label:'Theater & Drama',       maps:['Performing Arts']},
  {type:'Music',          icon:'üéµ', label:'Music',                 maps:['Performing Arts','Arts']},
  {type:'Dance',          icon:'üíÉ', label:'Dance',                 maps:['Performing Arts','Arts']},
  {type:'Film',           icon:'üé¨', label:'Film & Media',          maps:['Arts','Performing Arts']},
  // STEM & Academic
  {type:'STEM',           icon:'üî¨', label:'Science & STEM',        maps:['STEM']},
  {type:'Coding',         icon:'üíª', label:'Coding & Tech',         maps:['STEM']},
  {type:'Math',           icon:'üî¢', label:'Math & Logic',          maps:['STEM']},
  {type:'Pre-College',    icon:'üéì', label:'Pre-College / Academic',maps:['STEM','Leadership']},
  // Nature & Culture
  {type:'Nature',         icon:'üåø', label:'Nature & Outdoors',     maps:['Nature']},
  {type:'Traditional',    icon:'üèï', label:'Traditional Camp',      maps:['Traditional']},
  {type:'Language',       icon:'üåç', label:'Language Immersion',    maps:['Traditional','Leadership']},
  {type:'Leadership',     icon:'üèÜ', label:'Leadership',            maps:['Leadership']},
  {type:'Jewish',         icon:'‚ú°', label:'Jewish',                maps:['Jewish']},
];

const WIZ_TITLES = [
  ['About Your Kids',       "Tell us how many children you're planning for, and their ages."],
  ['Summer Dates',          'When does school end and when does it start back up?'],
  ['Activity Interests',    "What does each child enjoy? Describe their interests or pick from the list."],
  ['Camp Preferences',      'Fine-tune your results with a few more details.'],
  ['Hold Dates for Vacation','Are there any weeks you want to keep free? We\'ll skip those in your plan.'],
  ['Your Personalized Plan', 'Here\'s a recommended schedule ‚Äî review it and refine as needed.'],
];

function openWizard() {
  WIZ.kidCount = S.kids.length;
  WIZ.kidData  = S.kids.map(k => ({
    name:k.name||'', age:k.age||'',
    lastDay:k.lastDay||'2026-06-03', firstDay:k.firstDay||'2026-08-17',
    prefs:[], _interestText:'', _detected:null,
  }));
  while(WIZ.kidData.length < 4)
    WIZ.kidData.push({name:'',age:'',lastDay:'2026-06-03',firstDay:'2026-08-17',prefs:[],_interestText:'',_detected:null});
  WIZ.step=0; WIZ.style='both'; WIZ.totalBudget=null; WIZ.locationPref=''; WIZ.mode='together'; WIZ.vacationWeeks=new Set(); WIZ._recs=[];
  document.getElementById('wizOverlay').style.display='flex';
  wizRender();
}

function closeWizard() {
  document.getElementById('wizOverlay').style.display='none';
}

function wizNav(dir) {
  if(dir===1) {
    if(!wizSave()) return;
    if(WIZ.step===WIZ.numSteps-1){closeWizard();return;}
    WIZ.step++;
    if(WIZ.step===5) wizGenRecs();
  } else {
    if(WIZ.step===0){closeWizard();return;}
    WIZ.step--;
  }
  wizRender();
}

function wizRender() {
  const [title,sub] = WIZ_TITLES[WIZ.step];
  document.getElementById('wizTitle').textContent = title;
  document.getElementById('wizSub').textContent   = sub;
  document.getElementById('wizProg').innerHTML =
    Array.from({length:WIZ.numSteps},(_,i)=>
      `<div class="wiz-prog-dot${i<=WIZ.step?' on':''}"></div>`).join('');
  document.getElementById('wizBackBtn').textContent = WIZ.step===0 ? 'Cancel' : '‚Üê Back';
  const nb = document.getElementById('wizNextBtn');
  if(WIZ.step===WIZ.numSteps-1){nb.textContent='Done ‚úì';nb.style.background='#059669';}
  else{nb.textContent='Next ‚Üí';nb.style.background='';}
  document.getElementById('wizBody').innerHTML = wizBodyHtml();
}

function wizBodyHtml() {
  if(WIZ.step===0) return wizBody0();
  if(WIZ.step===1) return wizBody1();
  if(WIZ.step===2) return wizBody2();
  if(WIZ.step===3) return wizBody3();
  if(WIZ.step===4) return wizBody4();
  if(WIZ.step===5) return wizBody5();
  return '';
}

// ‚îÄ‚îÄ Step 0: Kids ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizBody0() {
  const countBtns = [1,2,3,4].map(n=>
    `<button class="wiz-tgl${WIZ.kidCount===n?' on':''}" onclick="wizSetKids(${n})">${n}</button>`
  ).join('');
  return `
    <div class="wiz-sec-title">How many children?</div>
    <div class="wiz-sec-sub">We'll plan camps for each of them.</div>
    <div class="wiz-toggle-row" id="wizKidCount">${countBtns}</div>
    <div id="wizKidFields">${wizKidFieldsHtml()}</div>`;
}

function wizKidFieldsHtml() {
  return Array.from({length:WIZ.kidCount},(_,i)=>{
    const kd=WIZ.kidData[i]||{};
    const col=KID_COLORS[i];
    return `<div class="wiz-kid-block" style="border-color:${col}30">
      <div class="wiz-kid-label">
        <span style="width:9px;height:9px;border-radius:50%;background:${col};display:inline-block"></span>
        Child ${i+1}
      </div>
      <div class="wiz-field-row">
        <div class="wf" style="flex:2">
          <label>Name (optional)</label>
          <input type="text" id="wn${i}" value="${kd.name||''}" placeholder="e.g. Emma">
        </div>
        <div class="wf">
          <label>Age this summer</label>
          <input type="number" id="wa${i}" min="4" max="18" value="${kd.age||''}" placeholder="8" style="width:72px">
        </div>
      </div>
    </div>`;
  }).join('');
}

function wizSetKids(n) {
  WIZ.kidCount=n;
  document.getElementById('wizKidCount').innerHTML=[1,2,3,4].map(x=>
    `<button class="wiz-tgl${WIZ.kidCount===x?' on':''}" onclick="wizSetKids(${x})">${x}</button>`
  ).join('');
  document.getElementById('wizKidFields').innerHTML=wizKidFieldsHtml();
}

// ‚îÄ‚îÄ Step 1: Dates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizBody1() {
  return Array.from({length:WIZ.kidCount},(_,i)=>{
    const kd=WIZ.kidData[i];
    const col=KID_COLORS[i];
    const nm=kd.name||`Child ${i+1}`;
    return `<div class="wiz-kid-block" style="border-color:${col}30">
      <div class="wiz-kid-label">
        <span style="width:9px;height:9px;border-radius:50%;background:${col};display:inline-block"></span>
        ${nm}
      </div>
      <div class="wiz-field-row">
        <div class="wf">
          <label>Last day of school</label>
          <input type="date" id="wld${i}" value="${kd.lastDay||'2026-06-03'}">
        </div>
        <div class="wf">
          <label>First day back</label>
          <input type="date" id="wfd${i}" value="${kd.firstDay||'2026-08-17'}">
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Step 2: Activity preferences (free-text + NLP matching) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WIZ_GROUPS = [
  {label:'Sports & Athletics', types:['Soccer','Basketball','Tennis','Swimming','Fencing','Martial Arts','Sports']},
  {label:'Arts & Creativity',  types:['Arts','Performing Arts','Music','Dance','Film']},
  {label:'STEM & Academic',    types:['STEM','Coding','Math','Pre-College']},
  {label:'Nature & Culture',   types:['Nature','Traditional','Language','Leadership','Jewish']},
];

// Keyword ‚Üí category mapping for natural language detection
const WIZ_KEYWORDS = {
  'Soccer':        ['soccer','futbol','futsal','mls'],
  'Basketball':    ['basketball','hoops','nba'],
  'Tennis':        ['tennis'],
  'Swimming':      ['swim','pool','aquatic','water polo','diving','synchronized swim'],
  'Fencing':       ['fenc','foil','epee','sabre','sword'],
  'Martial Arts':  ['karate','taekwondo','tae kwon do','judo','kung fu','jiu-jitsu','jiujitsu',
                    'martial art','self defense','self-defense','wrestling','mma','boxing','aikido'],
  'Sports':        ['sport','athletic','baseball','softball','volleyball','lacrosse','hockey',
                    'gymnastics','gymnastics','track','cross country','cycling','archery','rock climbing',
                    'equestrian','golf','crew','rowing','rugby','physical ed','fitness'],
  'Arts':          ['visual art','drawing','draw','painting','paint','craft','ceramics','pottery',
                    'sculpture','watercolor','illustrat','graphic design','comic','animation','creative writing'],
  'Performing Arts':['theater','theatre','drama','acting','improv','improvisation','stage','broadway','perform'],
  'Music':         ['music','sing','song','guitar','piano','violin','cello','instrument','band',
                    'orchestra','choir','chorus','drum','ukulele','voice','vocal','jazz'],
  'Dance':         ['danc','ballet','hip hop','contemporary dance','tap dance','jazz dance',
                    'ballroom','choreograph','modern dance','breakdanc'],
  'Film':          ['film','movie','cinema','video','filmmaking','photograph','podcast',
                    'journalism','media','storytelling','screenwriting'],
  'STEM':          ['science','stem','biology','chemistry','physics','astronomy','robotic',
                    'engineer','lab','experiment','space','geology','environment science',
                    'neuroscience','ai ','artificial intelligence','machine learning','3d print'],
  'Coding':        ['cod','programming','computer','software','web design','html','css','python',
                    'javascript','scratch','minecraft','game design','app','cybersecurity','hack'],
  'Math':          ['math','algebra','geometry','calculus','statistic','number theory',
                    'logic puzzle','olympiad','competition math','amc ','amc10','amc12'],
  'Pre-College':   ['pre-college','precollege','academic','college prep','enrichment','gifted',
                    'honors','advanced placement','sat prep','act prep','debate','model un'],
  'Nature':        ['nature','outdoor','hiking','hike','wilderness','forest','garden','environment',
                    'ecology','birdwatch','beach','ocean','marine','wildlife','backpack','camp fire',
                    'sustainability','climate','farm','agriculture'],
  'Traditional':   ['traditional camp','classic camp','general camp','overnight camp',
                    'sleepaway camp','bunk','cabin','all-around camp'],
  'Language':      ['language','spanish','french','mandarin','chinese','japanese','german',
                    'italian','korean','arabic','portuguese','hindi','immersion','bilingual',
                    'multilingual','foreign language','esl','second language'],
  'Leadership':    ['leadership','community service','public speaking','volunteer','civic',
                    'social justice','activism','entrepreneurship','business','startup'],
  'Jewish':        ['jewish','judaism','hebrew','bar mitzvah','bat mitzvah','shabbat','jewish culture'],
};

function wizDetectInterests(text) {
  const t = text.toLowerCase();
  const scores = {};
  for(const [type, words] of Object.entries(WIZ_KEYWORDS)) {
    for(const w of words) {
      if(t.includes(w)) scores[type] = (scores[type]||0)+1;
    }
  }
  return Object.entries(scores).filter(([,s])=>s>0).sort((a,b)=>b[1]-a[1]).map(([type])=>type);
}

function wizMatchText(ki) {
  const kd = WIZ.kidData[ki];
  const el = document.getElementById(`wizInterestText${ki}`);
  const text = el?.value || '';
  kd._interestText = text;
  if(!text.trim()) { kd._detected=[]; document.getElementById('wizBody').innerHTML=wizBodyHtml(); return; }
  const detected = wizDetectInterests(text);
  kd._detected = detected;
  // Add newly detected to this kid's prefs (never remove manually-selected ones)
  detected.forEach(t=>{ if(!kd.prefs.includes(t)) kd.prefs.push(t); });
  document.getElementById('wizBody').innerHTML = wizBodyHtml();
}

function wizBody2() {
  const blocks = Array.from({length:WIZ.kidCount}, (_,ki) => {
    const kd = WIZ.kidData[ki];
    const col = KID_COLORS[ki];
    const nm = kd.name || `Child ${ki+1}`;

    // Detected results banner for this kid
    let detectedHtml = '';
    if(kd._detected !== null && kd._detected.length === 0) {
      detectedHtml = `<div style="background:#fef9c3;border:1px solid #fde047;border-radius:9px;padding:.5rem .8rem;font-size:.78rem;color:#854d0e;margin-bottom:.65rem">
        No categories detected. Try different wording, or pick from the list below.</div>`;
    } else if(kd._detected?.length) {
      const chips = kd._detected.map(t=>{
        const a=WIZ_ACT.find(x=>x.type===t); if(!a) return '';
        return `<div class="pref-chip on" onclick="wizToggle(${ki},'${a.type.replace(/'/g,"\\'")}',this)"><span>${a.icon}</span>${a.label}</div>`;
      }).join('');
      detectedHtml = `<div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:.6rem .85rem;margin-bottom:.65rem">
        <div style="font-size:.67rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--primary);margin-bottom:.35rem">Matched interests</div>
        <div class="pref-grid">${chips}</div>
      </div>`;
    }

    // Full grouped chip grid for this kid
    const sections = WIZ_GROUPS.map(g=>{
      const chips = g.types.map(t=>{
        const a=WIZ_ACT.find(x=>x.type===t); if(!a) return '';
        return `<div class="pref-chip${kd.prefs.includes(a.type)?' on':''}" onclick="wizToggle(${ki},'${a.type.replace(/'/g,"\\'")}',this)"><span>${a.icon}</span>${a.label}</div>`;
      }).join('');
      return `<div style="margin-bottom:.65rem">
        <div style="font-size:.66rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:.35rem">${g.label}</div>
        <div class="pref-grid">${chips}</div>
      </div>`;
    }).join('');

    const hint = kd._detected?.length ? 'All interests ‚Äî adjust as needed' : 'Pick from the list';
    return `<div class="wiz-kid-block" style="border-color:${col}30">
      <div class="wiz-kid-label">
        <span style="width:9px;height:9px;border-radius:50%;background:${col};display:inline-block"></span>
        ${nm}
      </div>
      <div style="display:flex;gap:.5rem;margin-bottom:.65rem;align-items:flex-end">
        <textarea id="wizInterestText${ki}" rows="2"
          placeholder='e.g. "loves soccer and coding, interested in nature hikes"'
          style="flex:1;padding:.52rem .68rem;border:1.5px solid var(--border);border-radius:10px;font-size:.82rem;font-family:inherit;resize:none;outline:none;line-height:1.5;transition:border-color .15s,box-shadow .15s"
          onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(3,105,161,.12)'"
          onblur="this.style.borderColor='var(--border)';this.style.boxShadow=''"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();wizMatchText(${ki})}"
        >${kd._interestText||''}</textarea>
        <button onclick="wizMatchText(${ki})" style="padding:.5rem .9rem;background:var(--primary);color:white;border:none;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;line-height:1.4">Match ‚Üí</button>
      </div>
      ${detectedHtml}
      <div style="font-size:.67rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:.5rem">${hint}</div>
      ${sections}
    </div>`;
  }).join('');

  return `<div class="wiz-sec-sub" style="margin-bottom:.85rem">Describe what each child enjoys ‚Äî we'll match it to camp categories. Or pick directly from the list.</div>${blocks}`;
}

function wizToggle(ki,type,el) {
  const kd=WIZ.kidData[ki];
  if(kd.prefs.includes(type)){kd.prefs=kd.prefs.filter(t=>t!==type);el.classList.remove('on');}
  else{kd.prefs.push(type);el.classList.add('on');}
}

// ‚îÄ‚îÄ Step 3: Style, Budget, Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizBody3() {
  const styles=[
    {v:'day',  icon:'‚òÄÔ∏è', title:'Day camps only',    desc:'Home every night'},
    {v:'sleep',icon:'üåô', title:'Sleepaway welcome', desc:'Overnight adventures OK'},
    {v:'both', icon:'‚ú®', title:'Mix of both',       desc:'Best of both worlds'},
  ];
  const styleCards=styles.map(s=>
    `<div class="wiz-card${WIZ.style===s.v?' on':''}" onclick="wizPickStyle('${s.v}',this)">
      <div style="font-size:1.25rem;margin-bottom:.28rem">${s.icon}</div>
      <div class="wiz-card-title">${s.title}</div>
      <div class="wiz-card-desc">${s.desc}</div>
    </div>`
  ).join('');
  const budgetSet = WIZ.totalBudget !== null;
  const budgetInput = budgetSet ? `
    <div style="display:flex;align-items:center;gap:.55rem;margin-top:.65rem">
      <span style="font-size:1rem;font-weight:700;color:var(--text)">$</span>
      <input type="number" id="wizBudgetAmt" min="0" step="500"
        value="${WIZ.totalBudget||''}"
        placeholder="e.g. 5000"
        style="width:130px;padding:.42rem .65rem;border:1.5px solid var(--primary);border-radius:8px;font-size:.92rem;outline:none;font-family:inherit"
        oninput="wizSetBudgetAmt(this.value)"
      >
      <span style="font-size:.8rem;color:var(--muted)">total for the summer</span>
    </div>` : '';
  const hasHome=!!(S.profile?.homeAddress?.trim());
  const hasWork=!!(S.profile?.workAddress?.trim());
  const locSection=`
    <div style="margin-top:1.05rem">
      <div class="wiz-sec-title" style="font-size:.9rem">Location preference</div>
      ${hasHome||hasWork ? `
        <div class="wiz-sec-sub">Find camps close to where you'll be doing drop-off.</div>
        <div class="wiz-toggle-row" id="wizLocRow">
          ${hasHome?`<button class="wiz-tgl${WIZ.locationPref==='home'?' on':''}" onclick="wizPickLoc('home',this)">üè† Near home</button>`:''}
          ${hasWork?`<button class="wiz-tgl${WIZ.locationPref==='work'?' on':''}" onclick="wizPickLoc('work',this)">üè¢ Near work</button>`:''}
          <button class="wiz-tgl${WIZ.locationPref===''?' on':''}" onclick="wizPickLoc('',this)">No preference</button>
        </div>` : `
        <div class="wiz-sec-sub">Add addresses in
          <button onclick="closeWizard();openProfile()" style="background:none;border:none;color:var(--primary);font-weight:700;cursor:pointer;font-size:inherit;padding:0;text-decoration:underline">Profile settings</button>
          to enable this filter.
        </div>`}
    </div>`;
  const modeSection=WIZ.kidCount>1?`
    <div style="margin-top:1.05rem">
      <div class="wiz-sec-title" style="font-size:.9rem">Plan kids together or separately?</div>
      <div class="wiz-sec-sub">Together = same camp for all kids (easier logistics). Separately = each kid gets their own best match.</div>
      <div class="wiz-mode-grid" id="wizModeGrid">
        <div class="wiz-card${WIZ.mode==='together'?' on':''}" onclick="wizPickMode('together',this)">
          <div class="wiz-card-title">üë´ Together</div>
          <div class="wiz-card-desc">Same camp, shared experience. We'll find camps that work for all ages.</div>
        </div>
        <div class="wiz-card${WIZ.mode==='separate'?' on':''}" onclick="wizPickMode('separate',this)">
          <div class="wiz-card-title">üîÄ Separately</div>
          <div class="wiz-card-desc">Each kid gets the best camp for their individual age and interests.</div>
        </div>
      </div>
    </div>` : '';
  return `
    <div class="wiz-sec-title">Camp style</div>
    <div class="wiz-sec-sub">What kind of camps are you open to?</div>
    <div class="wiz-style-grid" id="wizStyleGrid">${styleCards}</div>
    <div class="wiz-sec-title" style="font-size:.9rem;margin-top:.9rem">Summer budget</div>
    <div class="wiz-sec-sub">Set a total and we'll stay within it ‚Äî or choose no limit.</div>
    <div class="wiz-toggle-row" id="wizBudgetRow">
      <button class="wiz-tgl${!budgetSet?' on':''}" onclick="wizSetBudgetMode(false,this)">No limit</button>
      <button class="wiz-tgl${budgetSet?' on':''}" onclick="wizSetBudgetMode(true,this)">Set a budget</button>
    </div>
    ${budgetInput}
    ${locSection}
    ${modeSection}`;
}

function wizPickStyle(v,el) {
  WIZ.style=v;
  el.closest('#wizStyleGrid').querySelectorAll('.wiz-card').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
}
function wizSetBudgetMode(set,el) {
  WIZ.totalBudget = set ? 0 : null;
  el.closest('#wizBudgetRow').querySelectorAll('.wiz-tgl').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('wizBody').innerHTML=wizBodyHtml();
  if(set) document.getElementById('wizBudgetAmt')?.focus();
}
function wizSetBudgetAmt(val) {
  const n=parseInt(val);
  WIZ.totalBudget = (isNaN(n)||n<=0) ? 0 : n;
}
function wizPickMode(v,el) {
  WIZ.mode=v;
  el.closest('#wizModeGrid').querySelectorAll('.wiz-card').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
}
function wizPickLoc(v,el) {
  WIZ.locationPref=v;
  el.closest('#wizLocRow').querySelectorAll('.wiz-tgl').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}

// ‚îÄ‚îÄ Step 4: Vacation holds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizBody4() {
  const monSet=new Set();
  WIZ.kidData.slice(0,WIZ.kidCount).forEach(kd=>{
    genWeeks(kd.lastDay,kd.firstDay).forEach(w=>monSet.add(w.mon));
  });
  const weeks=[...monSet].sort().map(mon=>({
    mon, fri:iso(addD(pd(mon),4)),
    label:`${fmt(pd(mon))} ‚Äì ${fmt(addD(pd(mon),4))}`,
  }));
  if(!weeks.length) return `<p style="color:var(--muted);font-size:.83rem">Complete the dates in step 2 to see summer weeks here.</p>`;
  const pills=weeks.map(w=>{
    const on=WIZ.vacationWeeks.has(w.mon);
    return `<div class="wiz-vac-pill${on?' on':''}" onclick="wizToggleVac('${w.mon}',this)">
      ${w.label}
    </div>`;
  }).join('');
  const count=WIZ.vacationWeeks.size;
  return `
    <div class="wiz-vac-grid">${pills}</div>
    <p style="font-size:.74rem;color:var(--muted);margin-top:.8rem">
      ${count?`<strong>${count} week${count===1?'':'s'}</strong> held for vacation.`:'No vacation weeks selected ‚Äî tap any weeks above to hold them.'}
    </p>`;
}

function wizToggleVac(mon,el) {
  if(WIZ.vacationWeeks.has(mon)){WIZ.vacationWeeks.delete(mon);el.classList.remove('on');}
  else{WIZ.vacationWeeks.add(mon);el.classList.add('on');}
  const count=WIZ.vacationWeeks.size;
  const note=el.closest('.wiz-body')?.querySelector('p');
  if(note) note.innerHTML=count
    ?`<strong>${count} week${count===1?'':'s'}</strong> held for vacation.`
    :'No vacation weeks selected ‚Äî tap any weeks above to hold them.';
}

// ‚îÄ‚îÄ Step 5: Results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizBody5() {
  // Filter summary bar
  const styleLabel={day:'Day only',sleep:'Sleepaway OK',both:'Day + Sleepaway'}[WIZ.style];
  const budgetLabel=WIZ.totalBudget>0?`$${WIZ.totalBudget.toLocaleString()} total`:'No limit';
  const allPrefsUnion=[...new Set(WIZ.kidData.slice(0,WIZ.kidCount).flatMap(kd=>kd.prefs))];
  let prefTags;
  if(WIZ.kidCount>1 && WIZ.mode==='separate') {
    prefTags=WIZ.kidData.slice(0,WIZ.kidCount).map((kd,i)=>{
      const nm=kd.name||`Child ${i+1}`;
      const col=KID_COLORS[i];
      const ints=kd.prefs.length?kd.prefs.map(p=>{const a=WIZ_ACT.find(x=>x.type===p);return a?a.icon+' '+a.label:p;}).join(', '):'All types';
      return `<span class="wiz-filter-tag" style="border-color:${col}50;background:${col}12"><span style="color:${col};font-weight:800">${nm}:</span> ${ints}</span>`;
    }).join('');
  } else {
    prefTags=allPrefsUnion.length
      ?allPrefsUnion.map(p=>{const a=WIZ_ACT.find(x=>x.type===p);return `<span class="wiz-filter-tag">${a?a.icon+' '+a.label:p}</span>`;}).join('')
      :'<span class="wiz-filter-tag">All types</span>';
  }
  const vacNote=WIZ.vacationWeeks.size?`<span class="wiz-filter-tag">${WIZ.vacationWeeks.size} wk vacation</span>`:'';
  const modeTag=WIZ.kidCount>1?`<span class="wiz-filter-tag">${WIZ.mode==='together'?'Together':'Separately'}</span>`:'';
  const locTag=WIZ.locationPref?`<span class="wiz-filter-tag">${WIZ.locationPref==='home'?'üè† Near home':'üè¢ Near work'}</span>`:'';
  const filterBar=`<div class="wiz-filter-bar">
    ${prefTags}
    <span class="wiz-filter-tag">${styleLabel}</span>
    <span class="wiz-filter-tag">${budgetLabel}</span>
    ${modeTag}${locTag}${vacNote}
    <button onclick="wizJumpTo(2)" style="margin-left:auto;background:none;border:none;font-size:.76rem;color:var(--primary);cursor:pointer;font-weight:700;white-space:nowrap">‚úèÔ∏è Refine</button>
  </div>`;

  const campRecs=WIZ._recs.filter(r=>!r.vacation);
  if(!campRecs.length) return filterBar+`
    <div style="text-align:center;padding:2rem 1rem">
      <div style="font-size:2.5rem;margin-bottom:.5rem">ü§î</div>
      <div style="font-size:.95rem;font-weight:700;margin-bottom:.4rem">No matches found</div>
      <p style="font-size:.8rem;color:var(--muted);line-height:1.6">Try fewer activity filters, a different camp style, or a wider budget. Click <strong>‚úèÔ∏è Refine</strong> above to adjust.</p>
    </div>`;

  const budgetNote = WIZ.totalBudget>0
    ? ` ¬∑ Est. total: <strong>$${(WIZ._budgetSpent||0).toLocaleString()}</strong> of $${WIZ.totalBudget.toLocaleString()}`
    : '';
  const nCamp=campRecs.length;
  const banner=`<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:.65rem 1rem;margin-bottom:.85rem;font-size:.79rem;color:#166534">
    ‚úÖ <strong>${nCamp} camp week${nCamp===1?'':'s'}</strong> added to your "Considering" list${budgetNote}. Promote any to "Planned" once you're ready to commit.
  </div>`;
  const items=WIZ._recs.map(r=>r.vacation ? `
    <div class="wiz-rec-card" style="opacity:.55;background:#f8fafc;border-color:#e2e8f0">
      <div class="wiz-rec-week" style="color:#94a3b8">${r.weekLabel}</div>
      <div class="wiz-rec-info">
        <div class="wiz-rec-name" style="color:#64748b">üèñ Vacation</div>
        <div class="wiz-rec-meta" style="color:#94a3b8">Held for family time</div>
      </div>
    </div>` : `
    <div class="wiz-rec-card">
      <div class="wiz-rec-week">${r.weekLabel}</div>
      <div class="wiz-rec-info">
        <div class="wiz-rec-name">${r.campName}</div>
        <div class="wiz-rec-meta">${r.type} ¬∑ ${r.isSleep?'Sleepaway':'Day camp'}${r.cost?' ¬∑ '+r.cost:''}</div>
      </div>
      ${r.kidLabel?`<span class="wiz-rec-who">${r.kidLabel}</span>`:''}
    </div>`).join('');
  return filterBar+banner+items;
}

// Jump to a specific step (used by Refine button)
function wizJumpTo(step) {
  WIZ.step=step;
  wizRender();
}

// ‚îÄ‚îÄ Recommendation engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizGenRecs() {
  if(!_campsLoaded){WIZ._recs=[];return;}
  WIZ._recs=[];
  const n=WIZ.kidCount;

  // Sync wizard kid data into S.kids
  while(S.kids.length<n)
    S.kids.push({name:`Child ${S.kids.length+1}`,lastDay:'2026-06-03',firstDay:'2026-08-17',age:'',consider:{},planned:{}});
  S.kids=S.kids.slice(0,n);
  S.kids.forEach((k,i)=>{
    const wd=WIZ.kidData[i];
    k.name=wd.name||`Child ${i+1}`; k.age=wd.age||'';
    k.lastDay=wd.lastDay; k.firstDay=wd.firstDay;
    k.consider={}; k.planned={};
  });
  S.activeKid=0;
  WEEKS=genAllWeeks();

  // Sync wizard vacation weeks into S.vacation so the weekly planner marks them
  S.vacation={};
  WIZ.vacationWeeks.forEach(mon=>{S.vacation[mon]=true;});

  // Update main app filter UI to reflect wizard choices
  S.slFilter=WIZ.style==='both'?'':WIZ.style;
  document.querySelectorAll('[data-sl]').forEach(b=>
    b.classList.toggle('active',b.dataset.sl===S.slFilter));
  document.querySelectorAll('#kidCountToggle .tgl').forEach((b,i)=>
    b.classList.toggle('active',i+1===n));

  // Extract city from address for proximity scoring (second-to-last comma segment)
  function cityFrom(addr) {
    if(!addr) return '';
    const parts=addr.split(',');
    return parts.length>=2 ? parts[parts.length-2].trim().toLowerCase() : parts[0].trim().toLowerCase();
  }
  const prefCity = WIZ.locationPref==='home' ? cityFrom(S.profile?.homeAddress)
                 : WIZ.locationPref==='work' ? cityFrom(S.profile?.workAddress) : '';

  // Scorer ‚Äî selMaps passed per call so each kid can have their own interest set
  function scorecamp(c,ageNum,selMaps) {
    if(WIZ.style==='day'   && c.sleep)  return -1;
    if(WIZ.style==='sleep' && !c.sleep) return -1;
    if(c.comingSoon) return -1;
    if(ageNum>0 && (ageNum<c.ageMin || ageNum>c.ageMax)) return -1;
    const ctags = c.tags || (c.type||'').split(',').map(t=>t.trim()).filter(Boolean);
    let sc = selMaps.size ? (ctags.some(t=>selMaps.has(t))?10:0) : 1;
    if(!c.appRequired) sc+=1;
    if(c.verified)     sc+=1;
    if(prefCity && (c.city?.toLowerCase()===prefCity || (c.loc && c.loc.toLowerCase().includes(prefCity)))) sc+=3;
    return sc;
  }
  function buildSelMaps(prefs) {
    return new Set(prefs.flatMap(p=>WIZ_ACT.find(a=>a.type===p)?.maps||[p]));
  }

  // Add a sleepaway session to a kid's consider list for all its covered weeks
  function addSleepSession(k,camp,sessId,locationId,locationName) {
    const found=findSessById(camp,sessId);
    if(!found) return;
    const {sess}=found;
    const ss=pd(sess.s), se=pd(sess.e);
    WEEKS.forEach(w=>{
      const wm=pd(w.mon), wf=pd(w.fri);
      if(ss<=wf && se>=wm) {
        if(!k.consider[w.mon]) k.consider[w.mon]=[];
        if(!k.consider[w.mon].some(e=>e.campId===camp.id&&e.sessId===sessId))
          k.consider[w.mon].push({campId:camp.id,sessId,locationId,locationName,color:camp.color,name:camp.name});
      }
    });
  }

  // Budget tracking ‚Äî shared across all kids so the cap is a true family total
  const cap = WIZ.totalBudget > 0 ? WIZ.totalBudget : null; // null = no limit
  let budgetSpent = 0;
  const budgetedSess = new Set(); // sleepaway session IDs already counted (avoid double-counting multi-week spans)
  function sessCostN(c, sessId) {
    if(sessId != null) { const found=findSessById(c,sessId); if(found?.sess?.costN) return found.sess.costN; }
    return c.costN || 0;
  }
  function projCost(c, sessId, kids) {
    const n = sessCostN(c, sessId);
    if(!n) return 0;
    if(c.sleep && sessId!=null) return budgetedSess.has(sessId) ? 0 : n*kids;
    return n*kids;
  }
  function recordCost(c, sessId, kids) {
    const n = sessCostN(c, sessId);
    if(!n) return;
    if(c.sleep && sessId!=null) {
      if(!budgetedSess.has(sessId)){budgetedSess.add(sessId);budgetSpent+=n*kids;}
    } else { budgetSpent+=n*kids; }
  }

  if(WIZ.mode==='together' || n===1) {
    // Together: find camps whose age range covers all kids
    const ages=S.kids.map(k=>parseInt(k.age)||0).filter(a=>a>0);
    const minA=ages.length?Math.min(...ages):5;
    const maxA=ages.length?Math.max(...ages):14;

    // Union of all kids' prefs so together-mode respects everyone's interests
    const togetherPrefs=[...new Set(WIZ.kidData.slice(0,n).flatMap(kd=>kd.prefs))];
    const togetherMaps=buildSelMaps(togetherPrefs);
    const scored=allCamps().filter(c=>{
      if(WIZ.style==='day'   && c.sleep)  return false;
      if(WIZ.style==='sleep' && !c.sleep) return false;
      if(c.comingSoon) return false;
      if(ages.length && (c.ageMax<minA || c.ageMin>maxA)) return false;
      return true;
    }).map(c=>({c,s:scorecamp(c,minA,togetherMaps)})).filter(x=>x.s>=0)
      .sort((a,b)=>b.s-a.s);

    const usedSess=new Set();
    let ri=0;
    WEEKS.forEach(w=>{
      const fri=iso(addD(pd(w.mon),4));
      if(WIZ.vacationWeeks.has(w.mon)) {
        WIZ._recs.push({mon:w.mon,weekLabel:`${fmt(pd(w.mon))} ‚Äì ${fmt(pd(fri))}`,vacation:true});
        return;
      }
      if(S.kids.every(k=>k.consider[w.mon]?.length||k.planned[w.mon])) return;
      let pick=null, pickSessId=null, pickLoc=null;
      for(let a=0;a<scored.length;a++){
        const {c}=scored[(ri+a)%scored.length];
        if(!campAvail(c,w.mon,fri)) continue;
        let sessId=null, loc=null;
        if(c.sleep){
          const sf=getSessForWeek(c,w.mon,fri);
          if(!sf||usedSess.has(sf.sess.id)) continue;
          sessId=sf.sess.id; loc=sf.loc;
        }
        if(cap!==null && budgetSpent+projCost(c,sessId,n)>cap) continue; // over budget
        if(c.sleep){usedSess.add(sessId);pickSessId=sessId;pickLoc=loc;}
        pick=c;
        ri=(ri+a+1)%scored.length;
        break;
      }
      if(!pick) return;
      recordCost(pick,pickSessId,n);
      S.kids.forEach((k,ki)=>{
        if(!kidHasWeek(ki,w.mon)) return;
        if(k.consider[w.mon]?.length||k.planned[w.mon]) return;
        if(pick.sleep&&pickSessId!=null) addSleepSession(k,pick,pickSessId,pickLoc?.id,pickLoc?.name);
        else {
          if(!k.consider[w.mon]) k.consider[w.mon]=[];
          k.consider[w.mon].push({campId:pick.id,sessId:null,locationId:null,locationName:null,color:pick.color,name:pick.name});
        }
      });
      const pickSess=pickSessId!=null?findSessById(pick,pickSessId)?.sess:null;
      if(S.kids.some((_,ki)=>kidHasWeek(ki,w.mon)))
        WIZ._recs.push({mon:w.mon,weekLabel:`${fmt(pd(w.mon))} ‚Äì ${fmt(pd(fri))}`,
          campName:pick.name,type:pick.type,isSleep:pick.sleep,kidLabel:n>1?'All kids':null,
          cost:fmtCost(pickSess?.cost??pick.cost,sessCostN(pick,pickSessId),pick.sleep)});
    });

  } else {
    // Separate: best camp per kid independently (budget still shared across all kids)
    S.kids.forEach((k,ki)=>{
      const ageNum=parseInt(WIZ.kidData[ki].age)||0;
      const kidName=k.name;
      const kidWeeks=genWeeks(k.lastDay,k.firstDay);
      const kidMaps=buildSelMaps(WIZ.kidData[ki].prefs);
      const scored=allCamps()
        .map(c=>({c,s:scorecamp(c,ageNum,kidMaps)})).filter(x=>x.s>=0)
        .sort((a,b)=>b.s-a.s);
      const usedSess=new Set();
      let ri=0;
      kidWeeks.forEach(w=>{
        const fri=iso(addD(pd(w.mon),4));
        if(WIZ.vacationWeeks.has(w.mon)) return; // held for vacation
        if(k.consider[w.mon]?.length||k.planned[w.mon]) return;
        let pick=null, pickSessId=null, pickLoc=null;
        for(let a=0;a<scored.length;a++){
          const {c}=scored[(ri+a)%scored.length];
          if(!campAvail(c,w.mon,fri)) continue;
          let sessId=null, loc=null;
          if(c.sleep){
            const sf=getSessForWeek(c,w.mon,fri);
            if(!sf||usedSess.has(sf.sess.id)) continue;
            sessId=sf.sess.id; loc=sf.loc;
          }
          if(cap!==null && budgetSpent+projCost(c,sessId,1)>cap) continue; // over budget
          if(c.sleep){usedSess.add(sessId);pickSessId=sessId;pickLoc=loc;}
          pick=c;
          ri=(ri+a+1)%scored.length;
          break;
        }
        if(!pick) return;
        recordCost(pick,pickSessId,1);
        if(pick.sleep&&pickSessId!=null) addSleepSession(k,pick,pickSessId,pickLoc?.id,pickLoc?.name);
        else {
          if(!k.consider[w.mon]) k.consider[w.mon]=[];
          k.consider[w.mon].push({campId:pick.id,sessId:null,locationId:null,locationName:null,color:pick.color,name:pick.name});
        }
        const pickSess=pickSessId!=null?findSessById(pick,pickSessId)?.sess:null;
        WIZ._recs.push({mon:w.mon,weekLabel:`${fmt(pd(w.mon))} ‚Äì ${fmt(pd(fri))}`,
          campName:pick.name,type:pick.type,isSleep:pick.sleep,kidLabel:n>1?kidName:null,
          cost:fmtCost(pickSess?.cost??pick.cost,sessCostN(pick,pickSessId),pick.sleep)});
      });
    });
    // Add vacation entries ‚Äî one per vacation week that falls in any kid's schedule
    const vacAdded=new Set();
    WIZ.kidData.slice(0,n).forEach(kd=>{
      genWeeks(kd.lastDay||'2026-06-03',kd.firstDay||'2026-08-17').forEach(w=>{
        if(WIZ.vacationWeeks.has(w.mon)&&!vacAdded.has(w.mon)){
          vacAdded.add(w.mon);
          const fri=iso(addD(pd(w.mon),4));
          WIZ._recs.push({mon:w.mon,weekLabel:`${fmt(pd(w.mon))} ‚Äì ${fmt(pd(fri))}`,vacation:true});
        }
      });
    });
    WIZ._recs.sort((a,b)=>a.mon<b.mon?-1:a.mon>b.mon?1:0); // sort by ISO date, not display string
  }
  WIZ._budgetSpent = budgetSpent; // expose for results display
  renderAll();
}

// ‚îÄ‚îÄ Persist wizard step data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wizSave() {
  if(WIZ.step===0) {
    for(let i=0;i<WIZ.kidCount;i++){
      WIZ.kidData[i].name=(document.getElementById(`wn${i}`)?.value||'').trim();
      WIZ.kidData[i].age =document.getElementById(`wa${i}`)?.value||'';
    }
  } else if(WIZ.step===1) {
    for(let i=0;i<WIZ.kidCount;i++){
      const ld=document.getElementById(`wld${i}`)?.value;
      const fd=document.getElementById(`wfd${i}`)?.value;
      if(ld) WIZ.kidData[i].lastDay =ld;
      if(fd) WIZ.kidData[i].firstDay=fd;
    }
  } else if(WIZ.step===2) {
    for(let i=0;i<WIZ.kidCount;i++){
      const t=document.getElementById(`wizInterestText${i}`)?.value;
      if(t!=null) WIZ.kidData[i]._interestText=t;
    }
  }
  return true;
}
</script>
</body>
</html>
